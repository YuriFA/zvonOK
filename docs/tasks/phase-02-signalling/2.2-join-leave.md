# –ó–∞–¥–∞—á–∞ 2.2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å join/leave –∫–æ–º–Ω–∞—Ç—ã

## –û–±–∑–æ—Ä

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–º–Ω–∞—Ç–∞–º–∏ —á–µ—Ä–µ–∑ Socket.io. –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—è—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–∞–º, –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥—Ä—É–≥–∏—Ö —É—á–∞—Å—Ç–Ω–∏–∫–∞—Ö.

---

## üéØ –¶–µ–ª—å

- `join_room` —Å–æ–±—ã—Ç–∏–µ ‚Äî –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ
- `leave_room` —Å–æ–±—ã—Ç–∏–µ ‚Äî –≤—ã—Ö–æ–¥ –∏–∑ –∫–æ–º–Ω–∞—Ç—ã
- `user_joined` —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî –Ω–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫
- `user_left` —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ ‚Äî —É—á–∞—Å—Ç–Ω–∏–∫ –≤—ã—à–µ–ª
- –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[Socket.io Rooms](https://socket.io/docs/v4/rooms/)**
   - `join()`, `leave()`, `to()`
   - Broadcast –≤ –∫–æ–º–Ω–∞—Ç—É

2. **[Server emit](https://socket.io/docs/v4/server-api/#serveremitsroomname)**
   - Broadcast vs directed emit

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[State management in Socket.io](https://socket.io/docs/v4/server-application-structure/)**

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å WebrtcGateway

**–í `apps/server/src/webrtc/webrtc.gateway.ts`:**
```typescript
import {
  WebSocketGateway,
  WebSocketServer,
  OnGatewayConnection,
  OnGatewayDisconnect,
  SubscribeMessage,
  MessageBody,
  ConnectedSocket,
} from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';
import { Logger } from '@nestjs/common';

interface JoinRoomPayload {
  roomId: string;
  userId: string;
  username: string;
}

interface UserInfo {
  socketId: string;
  userId: string;
  username: string;
}

@WebSocketGateway({
  cors: {
    origin: ['http://localhost:5173'],
    credentials: true,
  },
})
export class WebrtcGateway implements OnGatewayConnection, OnGatewayDisconnect {
  @WebSocketServer()
  server: Server;

  private logger = new Logger(WebrtcGateway.name);

  // –•—Ä–∞–Ω–∏–ª–∏—â–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ { roomId: Set<socketId> }
  private roomParticipants = new Map<string, Set<string>>();

  // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö { socketId: UserInfo }
  private users = new Map<string, UserInfo>();

  handleConnection(client: Socket) {
    this.logger.log(`–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è: ${client.id}`);
  }

  handleDisconnect(client: Socket) {
    this.logger.log(`–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è: ${client.id}`);

    // –ù–∞–π—Ç–∏ –∫–æ–º–Ω–∞—Ç—ã –≤ –∫–æ—Ç–æ—Ä—ã—Ö –±—ã–ª —É—á–∞—Å—Ç–Ω–∏–∫
    for (const [roomId, participants] of this.roomParticipants.entries()) {
      if (participants.has(client.id)) {
        this.handleLeaveRoom(client, { roomId });
      }
    }

    // –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    this.users.delete(client.id);
  }

  @SubscribeMessage('join_room')
  handleJoinRoom(
    @ConnectedSocket() client: Socket,
    @MessageBody() payload: JoinRoomPayload,
  ) {
    const { roomId, userId, username } = payload;

    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    this.users.set(client.id, {
      socketId: client.id,
      userId,
      username,
    });

    // –î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É –µ—Å–ª–∏ –Ω–µ—Ç
    if (!this.roomParticipants.has(roomId)) {
      this.roomParticipants.set(roomId, new Set());
    }

    // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å –∫ Socket.io –∫–æ–º–Ω–∞—Ç–µ
    client.join(roomId);
    this.roomParticipants.get(roomId)!.add(client.id);

    this.logger.log(
      `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${username} (${client.id}) –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ ${roomId}`,
    );

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    const participants = this.getRoomParticipants(roomId);
    client.emit('participants_list', {
      roomId,
      participants,
    });

    // –£–≤–µ–¥–æ–º–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ –Ω–æ–≤–æ–º
    client.to(roomId).emit('user_joined', {
      socketId: client.id,
      userId,
      username,
    });

    return { success: true, roomId };
  }

  @SubscribeMessage('leave_room')
  handleLeaveRoom(
    @ConnectedSocket() client: Socket,
    @MessageBody() payload: { roomId: string },
  ) {
    const { roomId } = payload;

    // –ü–æ–∫–∏–Ω—É—Ç—å Socket.io –∫–æ–º–Ω–∞—Ç—É
    client.leave(roomId);

    // –£–¥–∞–ª–∏—Ç—å –∏–∑ –ø–∞–º—è—Ç–∏
    const participants = this.roomParticipants.get(roomId);
    if (participants) {
      participants.delete(client.id);

      // –£–¥–∞–ª–∏—Ç—å –∫–æ–º–Ω–∞—Ç—É –µ—Å–ª–∏ –ø—É—Å—Ç–∞
      if (participants.size === 0) {
        this.roomParticipants.delete(roomId);
      }
    }

    const userInfo = this.users.get(client.id);

    this.logger.log(
      `–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ${userInfo?.username || client.id} –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É ${roomId}`,
    );

    // –£–≤–µ–¥–æ–º–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
    client.to(roomId).emit('user_left', {
      socketId: client.id,
      userId: userInfo?.userId,
      username: userInfo?.username,
    });

    return { success: true };
  }

  // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–æ–º–Ω–∞—Ç—ã
  private getRoomParticipants(roomId: string): UserInfo[] {
    const participants = this.roomParticipants.get(roomId);
    if (!participants) return [];

    return Array.from(participants)
      .map(socketId => this.users.get(socketId))
      .filter(Boolean) as UserInfo[];
  }
}
```

---

## üìñ Socket.io Rooms API

### join()

**–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å –∫–ª–∏–µ–Ω—Ç–∞ –∫ –∫–æ–º–Ω–∞—Ç–µ:**
```typescript
client.join('room-123');

// –ù–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–Ω–∞—Ç
client.join(['room-1', 'room-2']);

// –ö–æ–º–Ω–∞—Ç–∞ —Å –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–º –∏–º–µ–Ω–µ–º
client.join(`user-${userId}`);
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ö–ª–∏–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–º–Ω–∞—Ç—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –ë—Ä–æ–∫–µ—ÄËÆ∞‰Ωè —á—Ç–æ –∫–ª–∏–µ–Ω—Ç –≤ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç–µ
- –ú–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–º –≤ –∫–æ–º–Ω–∞—Ç–µ

---

### leave()

**–ü–æ–∫–∏–Ω—É—Ç—å –∫–æ–º–Ω–∞—Ç—É:**
```typescript
client.leave('room-123');

// –í—Å–µ –∫–æ–º–Ω–∞—Ç—ã
client.rooms.forEach(room => client.leave(room));
```

---

### to() / in()

**–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –≤ –∫–æ–º–Ω–∞—Ç–µ –ö–†–û–ú–ï –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:**
```typescript
// Broadcast –≤ –∫–æ–º–Ω–∞—Ç—É
this.server.to('room-123').emit('message', data);

// –¢–æ –∂–µ —Å–∞–º–æ–µ
this.server.in('room-123').emit('message', data);
```

**–û—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ö–†–û–ú–ï –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è:**
```typescript
// Broadcast –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–º
this.server.emit('broadcast', data);

// –í—Å–µ–º –≤ –∫–æ–º–Ω–∞—Ç–µ –ö–†–û–ú–ï –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
client.to('room-123').emit('message', data);
```

---

### fetchSockets()

**–ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –∫–æ–º–Ω–∞—Ç–µ:**
```typescript
const sockets = await this.server.in('room-123').fetchSockets();

sockets.forEach(socket => {
  console.log(socket.id);
  console.log(socket.handshake);
  console.log(socket.rooms);
});
```

**–í–∞–∂–Ω–æ:** –¢–æ–ª—å–∫–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –Ω–µ –≤ NestJS –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–∞—Ö!

---

## üéØ –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö

### Client payload

```typescript
// –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç
socket.emit('join_room', {
  roomId: 'clx...',
  userId: 'cly...',
  username: 'testuser',
});
```

### Server responses

```typescript
// –£—á–∞—Å—Ç–Ω–∏–∫—É –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
socket.emit('participants_list', {
  roomId: 'clx...',
  participants: [
    { socketId: 'abc', userId: '...', username: 'user1' },
    { socketId: 'def', userId: '...', username: 'user2' },
  ],
});

// –í—Å–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–º –≤ –∫–æ–º–Ω–∞—Ç–µ
socket.to(roomId).emit('user_joined', {
  socketId: 'abc',
  userId: '...',
  username: 'user1',
});
```

---

## üîå –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

### React Hook –¥–ª—è –∫–æ–º–Ω–∞—Ç

```typescript
// apps/client/src/hooks/use-room.ts
import { useEffect, useState, useRef } from 'react';
import { Socket } from 'socket.io-client';
import { socket } from '../lib/socket';

interface Participant {
  socketId: string;
  userId: string;
  username: string;
}

export function useRoom(roomId: string, userId: string, username: string) {
  const [participants, setParticipants] = useState<Participant[]>([]);
  const [isJoined, setIsJoined] = useState(false);

  useEffect(() => {
    if (!roomId) return;

    // –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
    socket.emit('join_room', { roomId, userId, username }, (response: any) => {
      if (response.success) {
        setIsJoined(true);
      }
    });

    // –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    socket.on('participants_list', ({ participants }: { participants: Participant[] }) => {
      setParticipants(participants);
    });

    // –ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
    socket.on('user_joined', (participant: Participant) => {
      setParticipants(prev => [...prev, participant]);
    });

    // –£—á–∞—Å—Ç–Ω–∏–∫ –ø–æ–∫–∏–Ω—É–ª –∫–æ–º–Ω–∞—Ç—É
    socket.on('user_left', ({ socketId }: { socketId: string }) => {
      setParticipants(prev => prev.filter(p => p.socketId !== socketId));
    });

    // Cleanup
    return () => {
      socket.emit('leave_room', { roomId });
      socket.off('participants_list');
      socket.off('user_joined');
      socket.off('user_left');
      setIsJoined(false);
    };
  }, [roomId, userId, username]);

  return { participants, isJoined };
}
```

---

## ‚ö†Ô∏è –ù—é–∞–Ω—Å—ã –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. –î—É–±–ª–∏–∫–∞—Ç—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –¥–≤–∞–∂–¥—ã –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏

**–†–µ—à–µ–Ω–∏–µ:** –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
```typescript
handleConnection(client: Socket) {
  // –£–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å
  this.users.delete(client.id);
}

handleJoinRoom(client: Socket, payload: JoinRoomPayload) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —É–∂–µ –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ
  const room = this.roomParticipants.get(payload.roomId);
  if (room?.has(client.id)) {
    return { success: false, error: 'Already in room' };
  }

  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
}
```

---

### 2. Memory leak

**–ü—Ä–æ–±–ª–µ–º–∞:** Map —Ä–∞—Å—Ç—ë—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:** Cleanup –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
```typescript
handleDisconnect(client: Socket) {
  // –£–¥–∞–ª–∏—Ç—å –∏–∑ –≤—Å–µ—Ö –∫–æ–º–Ω–∞—Ç
  for (const [roomId, participants] of this.roomParticipants) {
    participants.delete(client.id);
    if (participants.size === 0) {
      this.roomParticipants.delete(roomId);
    }
  }

  // –£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  this.users.delete(client.id);
}
```

---

### 3. Race conditions

**–ü—Ä–æ–±–ª–µ–º–∞:** `participants_list` –ø—Ä–∏—Ö–æ–¥–∏—Ç –¥–æ `user_joined`

**–†–µ—à–µ–Ω–∏–µ:** Promise –∏–ª–∏ callback
```typescript
// –° acknowledgement
socket.emit('join_room', payload, (response) => {
  console.log('–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—ë–Ω', response);
});

// –ò–ª–∏ Promise
const response = await socket.emitWithAck('join_room', payload);
```

---

### 4. In-memory state –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ restart

**–ü—Ä–æ–±–ª–µ–º–∞:** –í—Å–µ –∫–æ–º–Ω–∞—Ç—ã –ø—Ä–æ–ø–∞–¥–∞—é—Ç –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis Adapter
```bash
pnpm add @socket.io/redis-adapter redis
```

```typescript
import { createAdapter } from '@socket.io/redis-adapter';
import { createClient } from 'redis';

const pubClient = createClient({ url: 'redis://localhost:6379' });
const subClient = pubClient.duplicate();

await Promise.all([pubClient.connect(), subClient.connect()]);

this.server.adapter(createAdapter(pubClient, subClient));
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
- [ ] –ü—Ä–∏ join –∫–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- [ ] –û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç `user_joined`
- [ ] –ü—Ä–∏ leave —É—á–∞—Å—Ç–Ω–∏–∫–∏ –ø–æ–ª—É—á–∞—é—Ç `user_left`
- [ ] –ü—Ä–∏ disconnect –∫–ª–∏–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ—Ç—Å—è –∏–∑ –∫–æ–º–Ω–∞—Ç
- [ ] –ü—É—Å—Ç—ã–µ –∫–æ–º–Ω–∞—Ç—ã —É–¥–∞–ª—è—é—Ç—Å—è –∏–∑ –ø–∞–º—è—Ç–∏

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –û—Ç–∫—Ä–æ–π 2 –≤–∫–ª–∞–¥–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞

```typescript
// Tab 1
useRoom('room-1', 'user-1', 'Alice');

// Tab 2
useRoom('room-1', 'user-2', 'Bob');
```

### 2. –ü—Ä–æ–≤–µ—Ä—å –≤ –∫–æ–Ω—Å–æ–ª—è—Ö

**Tab 1:**
```
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Bob –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è
participants: [{ socketId: '...', userId: 'user-2', username: 'Bob' }]
```

**Tab 2:**
```
participants: [
  { socketId: '...', userId: 'user-1', username: 'Alice' },
  { socketId: '...', userId: 'user-2', username: 'Bob' }
]
```

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 2.3: WebRTC Signalling](./2.3-webrtc-signalling.md)**

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–µ—Ä–µ–¥ join

```typescript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–º–Ω–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ë–î
async handleJoinRoom(client: Socket, payload: JoinRoomPayload) {
  const room = await this.prisma.room.findUnique({
    where: { id: payload.roomId },
  });

  if (!room) {
    return { success: false, error: 'Room not found' };
  }

  // ... –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å join
}
```

---

### 2. –õ–∏–º–∏—Ç —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

```typescript
async handleJoinRoom(client: Socket, payload: JoinRoomPayload) {
  const room = await this.prisma.room.findUnique({
    where: { id: payload.roomId },
    include: { participants: true },
  });

  if (room.participants.length >= room.maxParticipants) {
    return { success: false, error: 'Room is full' };
  }

  // ... –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å join
}
```

---

### 3. –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```typescript
@SubscribeMessage('get_room_history')
async handleGetHistory(@MessageBody() payload: { roomId: string }) {
  const messages = await this.prisma.message.findMany({
    where: { roomId: payload.roomId },
    orderBy: { createdAt: 'asc' },
    take: 50,
  });

  return { messages };
}
```
