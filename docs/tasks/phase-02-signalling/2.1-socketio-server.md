# –ó–∞–¥–∞—á–∞ 2.1: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Socket.io –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

## –û–±–∑–æ—Ä

–ó–∞–º–µ–Ω–∞ Agora RTM –Ω–∞ Socket.io –¥–ª—è signalling. Socket.io ‚Äî —ç—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è real-timeÂèåÂêë–Ω–æ–π —Å–≤—è–∑–∏ –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º.

---

## üéØ –¶–µ–ª—å

- Socket.io —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ NestJS
- WebrtcGateway —Å–æ–∑–¥–∞–Ω
- WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∏ –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[Socket.io —Å NestJS](https://docs.nestjs.com/techniques/websockets)**
   - Gateway –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä
   - @WebSocketServer, @SubscribeMessage

2. **[Socket.io basics](https://socket.io/docs/v4/)**
   - Rooms, namespaces
   - Events, ack

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[WebSocket vs HTTP](https://ably.com/topic/websockets)** ‚Äî –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
- **[Socket.io emit](https://socket.io/docs/v4/server-api/#emit-value)** ‚Äî API

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞

```bash
# –í apps/server/
pnpm add @nestjs/websockets @nestjs/platform-socket.io
```

**–ß—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è:**
- `@nestjs/websockets` ‚Äî –±–∞–∑–æ–≤—ã–π –º–æ–¥—É–ª—å WebSocket –≤ NestJS
- `@nestjs/platform-socket.io` - –∞–¥–∞–ø—Ç–µ—Ä –¥–ª—è Socket.io

---

### –®–∞–≥ 2: –°–æ–∑–¥–∞—Ç—å Gateway

```bash
# –í apps/server/
nest g gateway webrtc
```

**–ß—Ç–æ —Å–æ–∑–¥–∞—Å—Ç—Å—è:**
```
apps/server/src/webrtc/
‚îú‚îÄ‚îÄ webrtc.gateway.ts
‚îú‚îÄ‚îÄ webrtc.module.ts
```

---

### –®–∞–≥ 3: –ë–∞–∑–æ–≤—ã–π WebrtcGateway

**–í `apps/server/src/webrtc/webrtc.gateway.ts`:**
```typescript
import {
  WebSocketGateway,
  WebSocketServer,
  OnGatewayInit,
  OnGatewayConnection,
  OnGatewayDisconnect,
  SubscribeMessage,
  MessageBody,
  ConnectedSocket,
} from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';

@WebSocketGateway({
  cors: {
    origin: ['http://localhost:5173'],  // Vite dev server
    credentials: true,  // –î–ª—è cookies
  },
  namespace: '/',  // Default namespace
})
export class WebrtcGateway
  implements OnGatewayInit, OnGatewayConnection, OnGatewayDisconnect
{
  @WebSocketServer()
  server: Server;

  // –°–µ—Ä–≤–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
  afterInit(server: Server) {
    console.log('WebSocket —Å–µ—Ä–≤–µ—Ä –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
  }

  // –ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è
  handleConnection(client: Socket) {
    console.log('–ö–ª–∏–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è:', client.id);
    // client.id ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  }

  // –ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è
  handleDisconnect(client: Socket) {
    console.log('–ö–ª–∏–µ–Ω—Ç –æ—Ç–∫–ª—é—á–∏–ª—Å—è:', client.id);
  }

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ —Å–æ–±—ã—Ç–∏—è
  @SubscribeMessage('ping')
  handlePing(@MessageBody() data: any, @ConnectedSocket() client: Socket) {
    console.log('–ü–æ–ª—É—á–µ–Ω–æ ping:', data);
    return { event: 'pong', data: 'pong –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞' };
  }
}
```

---

### –®–∞–≥ 4: WebrtcModule

**–í `apps/server/src/webrtc/webrtc.module.ts`:**
```typescript
import { Module } from '@nestjs/common';
import { WebrtcGateway } from './webrtc.gateway';

@Module({
  providers: [WebrtcGateway],
})
export class WebrtcModule {}
```

---

### –®–∞–≥ 5: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ AppModule

**–í `apps/server/src/app.module.ts`:**
```typescript
import { Module } from '@nestjs/common';
import { WebrtcModule } from './webrtc/webrtc.module';

@Module({
  imports: [
    // ...
    WebrtcModule,
  ],
})
export class AppModule {}
```

---

## üéØ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã Socket.io

### @WebSocketGateway

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:**
```typescript
@WebSocketGateway({
  cors: {
    origin: 'http://localhost:5173',
    credentials: true,
  },
  namespace: '/webrtc',  // –ö–∞—Å—Ç–æ–º–Ω—ã–π namespace: /webrtc
  path: '/socket.io/',   // –ü—É—Ç—å –∫ WebSocket endpoint
})
```

**URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:**
```javascript
// Default namespace
const socket = io('http://localhost:3000');

// Custom namespace
const socket = io('http://localhost:3000/webrtc');
```

---

### @WebSocketServer

**–ò–Ω—ä–µ–∫—Ü–∏—è Server:**
```typescript
@WebSocketServer()
server: Server;

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
this.server.emit('broadcast', { data: '–≤—Å–µ–º' });
this.server.to('room-id').emit('room', { data: '–∫–æ–º–Ω–∞—Ç–µ' });
```

---

### @SubscribeMessage

**–û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏–π:**
```typescript
@SubscribeMessage('event_name')
handleEvent(@MessageBody() data: any) {
  // –í–µ—Ä–Ω—ë—Ç –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é
  return { response: 'ack' };
}

// –° acknowledgement
@SubscribeMessage('with_ack')
handleWithAck(@MessageBody() data: any, @ConnectedSocket() client: Socket) {
  client.emit('response', { ack: true });
}
```

---

## üîå –ö–ª–∏–µ–Ω—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –í–∞—Ä–∏–∞–Ω—Ç A: HTML —Ñ–∞–π–ª (–±—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç)

**–°–æ–∑–¥–∞–π `test-socket.html`:**
```html
<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
</head>
<body>
  <h1>Socket.io Test</h1>
  <div id="messages"></div>
  <button onclick="sendPing()">Send Ping</button>

  <script>
    const socket = io('http://localhost:3000', {
      withCredentials: true,
    });

    socket.on('connect', () => {
      console.log('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ!', socket.id);
      addMessage('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ' + socket.id);
    });

    socket.on('disconnect', () => {
      console.log('–û—Ç–∫–ª—é—á–µ–Ω–æ');
      addMessage('–û—Ç–∫–ª—é—á–µ–Ω–æ');
    });

    socket.on('pong', (data) => {
      console.log('–ü–æ–ª—É—á–µ–Ω–æ pong:', data);
      addMessage('Pong: ' + JSON.stringify(data));
    });

    function sendPing() {
      socket.emit('ping', { message: 'ping –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞' });
    }

    function addMessage(msg) {
      const div = document.createElement('div');
      div.textContent = msg;
      document.getElementById('messages').appendChild(div);
    }
  </script>
</body>
</html>
```

**–û—Ç–∫—Ä–æ–π –≤ –±—Ä–∞—É–∑–µ—Ä–µ:**
```bash
open test-socket.html
```

---

### –í–∞—Ä–∏–∞–Ω—Ç B: React –∫–æ–º–ø–æ–Ω–µ–Ω—Ç

**–í `apps/client/src/pages/test-socket.tsx`:**
```typescript
import { useEffect, useState } from 'react';
import { io, Socket } from 'socket.io-client';

export default function TestSocket() {
  const [socket, setSocket] = useState<Socket | null>(null);
  const [connected, setConnected] = useState(false);
  const [messages, setMessages] = useState<string[]>([]);

  useEffect(() => {
    const socketInstance = io('http://localhost:3000', {
      withCredentials: true,
    });

    socketInstance.on('connect', () => {
      setConnected(true);
      addMessage('–ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ' + socketInstance.id);
    });

    socketInstance.on('disconnect', () => {
      setConnected(false);
      addMessage('–û—Ç–∫–ª—é—á–µ–Ω–æ');
    });

    socketInstance.on('pong', (data) => {
      addMessage('Pong: ' + JSON.stringify(data));
    });

    setSocket(socketInstance);

    return () => {
      socketInstance.disconnect();
    };
  }, []);

  const addMessage = (msg: string) => {
    setMessages(prev => [...prev, msg]);
  };

  const sendPing = () => {
    socket?.emit('ping', { message: 'ping –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞' });
  };

  return (
    <div className="p-4">
      <h1 className="text-2xl mb-4">Socket.io Test</h1>
      <div className={`mb-4 ${connected ? 'text-green-500' : 'text-red-500'}`}>
        {connected ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ'}
      </div>
      <button
        onClick={sendPing}
        disabled={!connected}
        className="px-4 py-2 bg-blue-500 text-white rounded disabled:opacity-50"
      >
        Send Ping
      </button>
      <div className="mt-4">
        {messages.map((msg, i) => (
          <div key={i}>{msg}</div>
        ))}
      </div>
    </div>
  );
}
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –õ–æ–≥–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

```typescript
handleConnection(client: Socket) {
  console.log('Client connected:', {
    id: client.id,
    handshake: client.handshake,
    rooms: client.rooms,
  });
}
```

### –õ–æ–≥–∏ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

```javascript
const socket = io('http://localhost:3000', {
  withCredentials: true,
  autoConnect: false,
  reconnection: true,
  reconnectionAttempts: 5,
  reconnectionDelay: 1000,
});

socket.on('connect_error', (error) => {
  console.error('Connection error:', error);
});

socket.on('error', (error) => {
  console.error('Socket error:', error);
});

socket.connect();
```

---

## ‚ö†Ô∏è –ù—é–∞–Ω—Å—ã –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. CORS –æ—à–∏–±–∫–∏

**–ü—Ä–æ–±–ª–µ–º–∞:** CORS policy blocked

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
@WebSocketGateway({
  cors: {
    origin: ['http://localhost:5173', 'http://localhost:5174'],  // –í—Å–µ origin
    credentials: true,
  },
})
```

**–ò–ª–∏ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π origin:**
```typescript
@WebSocketGateway({
  cors: {
    origin: (origin, callback) => {
      const allowedOrigins = ['http://localhost:5173'];
      if (!origin || allowedOrigins.includes(origin)) {
        callback(null, true);
      } else {
        callback(new Error('Origin not allowed'));
      }
    },
    credentials: true,
  },
})
```

---

### 2. Cookies –Ω–µ –ø–µ—Ä–µ–¥–∞—é—Ç—Å—è

**–ü—Ä–æ–±–ª–µ–º–∞:** JWT —Ç–æ–∫–µ–Ω –≤ cookie –Ω–µ –≤–∏–¥–µ–Ω –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ö–ª–∏–µ–Ω—Ç
const socket = io('http://localhost:3000', {
  withCredentials: true,  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
});

// –°–µ—Ä–≤–µ—Ä
@WebSocketGateway({
  cors: {
    credentials: true,  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ!
  },
})
```

---

### 3. Namespace confusion

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ default namespace –≤–º–µ—Å—Ç–æ custom

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –°–µ—Ä–≤–µ—Ä
@WebSocketGateway({ namespace: '/webrtc' })

// –ö–ª–∏–µ–Ω—Ç
const socket = io('http://localhost:3000/webrtc', {
  withCredentials: true,
});
```

---

### 4. Reconnection issues

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–ª–∏–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
const socket = io('http://localhost:3000', {
  reconnection: true,
  reconnectionAttempts: 5,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,
});
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] Socket.io –ø–∞–∫–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] WebrtcGateway —Å–æ–∑–¥–∞–Ω –∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
- [ ] –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞ –≤–∏–¥–Ω–æ –ª–æ–≥
- [ ] –ö–ª–∏–µ–Ω—Ç –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç—å `ping` –∏ –ø–æ–ª—É—á–∏—Ç—å `pong`
- [ ] –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –ª–æ–≥

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 2.2: Join/leave –∫–æ–º–Ω–∞—Ç—ã](./2.2-join-leave.md)**

---

## üí° –ü–æ–ª–µ–∑–Ω–æ–µ

### Socket.io vs WebSocket

| –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞ | Socket.io | WebSocket |
|----------------|-----------|-----------|
| –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ | ‚úì | ‚úì |
| Fallback (polling) | ‚úì | ‚úó |
| Rooms | ‚úì –í—Å—Ç—Ä–æ–µ–Ω—ã | ‚úó –°–∞–º–æ–¥–µ–ª—å–Ω—ã–µ |
| Reconnection | ‚úì –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ | ‚úó –°–∞–º–æ–ø–∏—Å–Ω—ã–π |
| Binary data | ‚úì | ‚úì |
| –ë—Ä–∞—É–∑–µ—Ä API | - | ‚úì Native |

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Socket.io:**
- –ù—É–∂–Ω—ã rooms
- –ù—É–∂–µ–Ω fallback (—Å—Ç–∞—Ä—ã–µ –±—Ä–∞—É–∑–µ—Ä—ã)
- –ù—É–∂–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π reconnection

**–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å WebSocket:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
- –ù–∞—Ç–∏–≤–Ω—ã–π API
- –ü—Ä–æ—Å—Ç–æ–π signalling

---

### Socket.io —Å–æ–±—ã—Ç–∏—è

**–°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:**
- `connect` ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- `disconnect` ‚Äî –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ
- `error` ‚Äî –æ—à–∏–±–∫–∞
- `connect_error` ‚Äî –æ—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `reconnect` ‚Äî —É—Å–ø–µ—à–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
- `reconnect_attempt` ‚Äî –ø–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–ö–∞—Å—Ç–æ–º–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è:**
- –õ—é–±–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ `emit`/`on`
