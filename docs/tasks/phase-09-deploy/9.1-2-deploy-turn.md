# –ó–∞–¥–∞—á–∏ 9.1-9.2: –î–µ–ø–ª–æ–π –∏ TURN —Å–µ—Ä–≤–µ—Ä

## –û–±–∑–æ—Ä

–†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Å–µ—Ä–≤–µ—Ä —Å HTTPS –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ TURN —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è NAT traversal.

## üéØ –¶–µ–ª—å

- HTTPS —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º (Let's Encrypt)
- TURN —Å–µ—Ä–≤–µ—Ä (coturn) –¥–ª—è relay —Ç—Ä–∞—Ñ–∏–∫–∞
- –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –¥–æ–º–µ–Ω–Ω–æ–º—É –∏–º–µ–Ω–∏
- WebRTC —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production

## üìö –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ

1. [Caddy server docs](https://caddyserver.com/docs/quick-starts/https)
2. [coturn installation](https://github.com/coturn/coturn/wiki/turnserver)

## üìù –®–∞–≥ 1: Caddy –¥–ª—è HTTPS

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Caddy
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/gpg.key' | sudo gpg --dearmor -o /usr/share/keyrings/caddy-stable-archive-keyring.gpg
curl -1sLf 'https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt' | sudo tee /etc/apt/sources.list.d/caddy-stable.list
sudo apt update
sudo apt install caddy
```

**Caddyfile:**
```
your-domain.com {
    reverse_proxy localhost:3000
}

# –ò–ª–∏ —Å WebSocket (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
your-domain.com {
    handle_path /socket.io/* {
        reverse_proxy localhost:3000
    }

    reverse_proxy localhost:3000
}
```

```bash
# –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å Caddy
sudo systemctl reload caddy
```

**Caddy –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- –ü–æ–ª—É—á–∏—Ç Let's Encrypt —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
- –ù–∞—Å—Ç—Ä–æ–∏—Ç HTTPS
- –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç

## üìù –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ coturn

```bash
sudo apt update
sudo apt install coturn
```

**–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è `/etc/turnserver.conf`:**
```
# –°–µ—Ç–µ–≤—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
listening-port=3478
fingerprint
lt-cred-mech

# TURN credentials
user=username:strong-password
realm=your-domain.com

# –õ–æ–≥–∏
log-file=/var/log/turnserver.log
verbose

# TLS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –¥–ª—è TURN over TLS)
cert=/etc/letsencrypt/live/your-domain.com/fullchain.pem
pkey=/etc/letsencrypt/live/your-domain.com/privkey.pem

# –†–∞–∑—Ä–µ—à–∏—Ç—å relay –¥–ª—è –≤—Å–µ—Ö IP (–æ–≥—Ä–∞–Ω–∏—á—å –≤ –ø—Ä–æ–¥–µ!)
no-stdout-log
simple-log
```

**–ó–∞–ø—É—Å—Ç–∏—Ç—å:**
```bash
sudo systemctl restart coturn
sudo systemctl status coturn
```

## üìù –®–∞–≥ 3: –û–±–Ω–æ–≤–∏—Ç—å ICE –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é

```typescript
// apps/client/src/lib/config.ts
export const iceServers = {
  iceServers: [
    // STUN
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:your-domain.com:3478' },

    // TURN
    {
      urls: 'turn:your-domain.com:3478',
      username: 'username',
      credential: 'strong-password',
    },
    {
      urls: 'turn:your-domain.com:3478?transport=tcp',
      username: 'username',
      credential: 'strong-password',
    },
  ],
};
```

## üìù –®–∞–≥ 4: Production –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

**`.env.production` –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:**
```env
# Database
DATABASE_URL="postgresql://user:password@localhost:5432/webrtc_chat"

# JWT
JWT_SECRET="—Å–∏–ª—å–Ω–æ-—Å–ª—É—á–∞–π–Ω—ã–π-—Å–µ–∫—Ä–µ—Ç-–º–∏–Ω–∏–º—É–º-32-—Å–∏–º–≤–æ–ª–∞"
JWT_EXPIRES_IN="24h"

# Server
PORT=3000
NODE_ENV="production"

# TURN (–¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ credentials)
TURN_SERVER_URL="your-domain.com:3478"
TURN_USERNAME="username"
TURN_PASSWORD="strong-password"
```

## üìù –®–∞–≥ 5: –î–µ–ø–ª–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

**–í–∞—Ä–∏–∞–Ω—Ç A: Docker Compose (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞)**

–°–æ–∑–¥–∞–π `docker-compose.prod.yml`:

```yaml
services:
  postgres:
    image: postgres:16-alpine
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER}"]
      interval: 10s
      timeout: 5s
      retries: 5

  coturn:
    image: instrumentisto/coturn:latest
    restart: always
    network_mode: host  # –î–ª—è –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–æ—Ä—Ç–∞–º
    environment:
      TURN_SECRET_KEY: ${TURN_SECRET}
      TURN_REALM: your-domain.com
    command: >
      --log-file=stdout
      --listening-port=3478
      --fingerprint
      --lt-cred-mech
      --user=${TURN_USERNAME}:${TURN_PASSWORD}
      --realm=your-domain.com
      --external-ip=$(curl -s https://api.ipify.org)

  app:
    build:
      context: .
      dockerfile: Dockerfile
    restart: always
    environment:
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      PORT: 3000
      NODE_ENV: production
    depends_on:
      postgres:
        condition: service_healthy

volumes:
  postgres_data:
```

**`.env.production`:**
```env
POSTGRES_USER=webrtc
POSTGRES_PASSWORD=strong-password
POSTGRES_DB=webrtc_chat
DATABASE_URL=postgresql://webrtc:strong-password@postgres:5432/webrtc_chat

JWT_SECRET=very-long-random-secret-minimum-32-characters

TURN_USERNAME=turnuser
TURN_PASSWORD=turn-password
TURN_SECRET=another-secret-for-turn
```

**–ó–∞–ø—É—Å–∫:**
```bash
docker compose -f docker-compose.prod.yml up -d
```

---

**–í–∞—Ä–∏–∞–Ω—Ç B: –¢—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω—ã–π –¥–µ–ø–ª–æ–π –±–µ–∑ Docker**

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å PostgreSQL
sudo apt install postgresql postgresql-contrib
sudo systemctl start postgresql

# –°–æ–∑–¥–∞—Ç—å –ë–î –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
sudo -u postgres psql
CREATE DATABASE webrtc_chat;
CREATE USER webrtc WITH PASSWORD 'strong-password';
GRANT ALL PRIVILEGES ON DATABASE webrtc_chat TO webrtc;
\q

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ø–æ
git clone https://github.com/your-repo/webrtc-chat.git
cd webrtc-chat

# –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
pnpm install

# –°–æ–±—Ä–∞—Ç—å
pnpm build

# –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏–∏
cd apps/server
pnpm prisma migrate deploy

# –ó–∞–ø—É—Å—Ç–∏—Ç—å (—Å PM2)
pnpm add -D pm2
npx pm2 start dist/main.js --name webrtc-chat
npx pm2 save
npx pm2 startup
```

## üìù –®–∞–≥ 6: –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ TURN credentials

**–î–ª—è –±–æ–ª—å—à–µ–π –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏, –≥–µ–Ω–µ—Ä–∏—Ä—É–π –≤—Ä–µ–º–µ–Ω–Ω—ã–µ credentials:**

```typescript
// –í—Ä–µ–º–µ–Ω–Ω—ã–π TURN credential (valid for 24 hours)
import crypto from 'crypto';

function generateTurnCredential(username: string, secret: string) {
  const timestamp = Math.floor(Date.now() / 1000) + 86400; // 24 hours
  const turnUsername = `${timestamp}:${username}`;
  const hmac = crypto.createHmac('sha1', secret);
  hmac.update(turnUsername);
  const turnPassword = hmac.digest('base64');

  return { username: turnUsername, password: turnPassword };
}
```

```typescript
// API endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ICE servers
@Get('ice-servers')
getIceServers() {
  const credential = generateTurnCredential(
    process.env.TURN_USERNAME!,
    process.env.TURN_PASSWORD!
  );

  return {
    iceServers: [
      { urls: 'stun:stun.l.google.com:19302' },
      {
        urls: 'turn:your-domain.com:3478',
        username: credential.username,
        credential: credential.password,
      },
    ],
  };
}
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. Firewall –ø—Ä–∞–≤–∏–ª–∞

```bash
# –û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç—ã
sudo ufw allow 80/tcp    # HTTP
sudo ufw allow 443/tcp   # HTTPS
sudo ufw allow 3478/tcp  # TURN
sudo ufw allow 3478/udp  # STUN/TURN
sudo ufw allow 5349/tcp  # TURN-TLS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
sudo ufw allow 5349/udp  # TURN-TLS (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
```

### 2. TURN bandwidth

TURN –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞. –î–ª—è 10 simultaneous –≤–∏–¥–µ–æ calls:
- –ö–∞–∂–¥—ã–π –ø–æ—Ç–æ–∫ ~2 Mbps
- 10 participants √ó 2 Mbps = 20 Mbps upload + download
- –†–∞—Å—Å—á–∏~–∞–π server bandwidth —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ

### 3. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å coturn —Å—Ç–∞—Ç—É—Å
sudo systemctl status coturn

# –õ–æ–≥–∏
sudo tail -f /var/log/turnserver.log

# –¢–µ—Å—Ç TURN
turnutils_uclient -v -u username -w password your-domain.com
```

### 4. STUN vs TURN

| –°–µ—Ä–≤–µ—Ä | –ö–æ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç | –ü—Ä–æ–ø—É—Å–∫–Ω–∞—è —Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç—å |
|--------|----------------|------------------------|
| STUN | Open NAT | –ù–µ—Ç |
| TURN | –õ—é–±–æ–π NAT | –í—ã—Å–æ–∫–∞—è |

**–í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π TURN –≤ production –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.**

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] –°–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS
- [ ] –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è
- [ ] TURN —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã
- [ ] ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –≤–∫–ª—é—á–∞—é—Ç TURN
- [ ] WebRTC —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production

## üìã –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–µ–ø–ª–æ—è

**–î–ª—è Docker Compose:**
- [ ] –î–æ–º–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ server IP
- [ ] Firewall –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–µ –ø–æ—Ä—Ç—ã
- [ ] `docker-compose.prod.yml` —Å–æ–∑–¥–∞–Ω
- [ ] `.env.production` –∑–∞–ø–æ–ª–Ω–µ–Ω
- [ ] `docker compose up -d` –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ
- [ ] –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è: `docker compose logs -f`

**–î–ª—è —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è:**
- [ ] –î–æ–º–µ–Ω –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ server IP
- [ ] Firewall –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω—É–∂–Ω—ã–µ –ø–æ—Ä—Ç—ã
- [ ] PostgreSQL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] Prisma migrations –ø—Ä–∏–º–µ–Ω–µ–Ω—ã
- [ ] `.env.production` –∑–∞–ø–æ–ª–Ω–µ–Ω
- [ ] Caddy —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω
- [ ] coturn —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- [ ] –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ PM2
- [ ] –õ–æ–≥–∏ –ø—Ä–æ–≤–µ—Ä—è—é—Ç—Å—è
- [ ] Backup –Ω–∞—Å—Ç—Ä–æ–µ–Ω

## üéâ –ü–æ–∑–¥—Ä–∞–≤–ª—è—é!

–¢—ã –∑–∞–≤–µ—Ä—à–∏–ª –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ Google Meet Clone:
1. ‚úÖ –ë–∞–∑–æ–≤–∞—è —Ç–µ–æ—Ä–∏—è WebRTC
2. ‚úÖ Backend —Å Auth + –ë–î
3. ‚úÖ Signalling —Å–µ—Ä–≤–µ—Ä
4. ‚úÖ P2P –≤–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫
5. ‚úÖ –®–µ—Ä–∏–Ω–≥ —ç–∫—Ä–∞–Ω–∞
6. ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
7. ‚úÖ –ß–∞—Ç
8. ‚úÖ SFU –¥–ª—è –≥—Ä—É–ø–ø
9. ‚úÖ –í–∏–¥–µ–æ-–≥—Ä–∏–¥
10. ‚úÖ –î–µ–ø–ª–æ–π —Å TURN

**–î–∞–ª—å–Ω–µ–π—à–∏–µ —à–∞–≥–∏:**
- –î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å –∑–≤–æ–Ω–∫–æ–≤
- –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å breakout rooms
- –î–æ–±–∞–≤–∏—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Ñ–æ–Ω
- –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å AI —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é
- –î–æ–±–∞–≤–∏—Ç—å reactions/emojis
- –∏ –º–Ω–æ–≥–æ–µ –¥—Ä—É–≥–æ–µ!

–£–¥–∞—á–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ! üöÄ
