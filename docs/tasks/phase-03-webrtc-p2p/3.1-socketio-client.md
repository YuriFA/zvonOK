# –ó–∞–¥–∞—á–∞ 3.1: –ü–æ–¥–∫–ª—é—á–∏—Ç—å Socket.io –∫–ª–∏–µ–Ω—Ç

## –û–±–∑–æ—Ä

–ó–∞–º–µ–Ω–∞ Agora RTM –Ω–∞ Socket.io –≤ React –ø—Ä–æ–µ–∫—Ç–µ. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å signalling —Å–µ—Ä–≤–µ—Ä–æ–º.

---

## üéØ –¶–µ–ª—å

- Agora RTM —É–¥–∞–ª—ë–Ω
- Socket.io –∫–ª–∏–µ–Ω—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- Socket.instance –¥–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Å—ë–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[socket.io-client React](https://socket.io/docs/v4/client-api/)**
   - API –∫–ª–∏–µ–Ω—Ç–∞
   - Options, —Å–æ–±—ã—Ç–∏—è

2. **[React Hooks + Socket.io](https://socket.io/docs/v4/react-socketio-example/)**
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å React

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[Socket.io options](https://socket.io/docs/v4/client-options/)** ‚Äî –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –£–¥–∞–ª–∏—Ç—å Agora RTM

```bash
# –í apps/client/
pnpm remove agora-rtm-sdk
```

**–û—á–∏—Å—Ç–∏—Ç—å –∏–º–ø–æ—Ä—Ç—ã:**
```bash
# –ù–∞–π—Ç–∏ –≤—Å–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
grep -r "agora" apps/client/src/

# –£–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª—ã —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å Agora
rm apps/client/src/lib/agora.ts
# –∏ –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã
```

---

### –®–∞–≥ 2: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å socket.io-client

```bash
# –í apps/client/
pnpm add socket.io-client
```

---

### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å socket –∏–Ω—Å—Ç–∞–Ω—Å

**–í `apps/client/src/lib/socket.ts`:**
```typescript
import { io, Socket } from 'socket.io-client';

const SOCKET_URL = import.meta.env.VITE_SOCKET_URL || 'http://localhost:3000';

export const socket: Socket = io(SOCKET_URL, {
  // –í–∞–∂–Ω–æ –¥–ª—è cookies (JWT —Ç–æ–∫–µ–Ω)
  withCredentials: true,

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  reconnection: true,
  reconnectionAttempts: 5,
  reconnectionDelay: 1000,
  reconnectionDelayMax: 5000,

  // –ù–µ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  autoConnect: false,

  // –õ–æ–≥–∏ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
  debug: import.meta.env.DEV,
});

// –°–æ–±—ã—Ç–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
socket.on('connect', () => {
  console.log('Socket –ø–æ–¥–∫–ª—é—á—ë–Ω:', socket.id);
});

socket.on('disconnect', (reason) => {
  console.log('Socket –æ—Ç–∫–ª—é—á—ë–Ω:', reason);
});

socket.on('connect_error', (error) => {
  console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è:', error);
});

export default socket;
```

---

### –®–∞–≥ 4: TypeScript —Ç–∏–ø—ã

**–í `apps/client/src/types/socket.ts`:`
```typescript
import { DefaultEventsMap } from 'socket.io-client';

// –°–æ–±—ã—Ç–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞
export interface ServerToClientEvents {
  // –ö–æ–º–Ω–∞—Ç—ã
  participants_list: (data: {
    roomId: string;
    participants: ParticipantInfo[];
  }) => void;

  user_joined: (participant: ParticipantInfo) => void;
  user_left: (data: { socketId: string; userId: string; username: string }) => void;

  // WebRTC signalling
  offer: (data: {
    offer: RTCSessionDescriptionInit;
    from: string;
    roomId: string;
  }) => void;

  answer: (data: {
    answer: RTCSessionDescriptionInit;
    from: string;
    roomId: string;
  }) => void;

  ice_candidate: (data: {
    candidate: RTCIceCandidateInit;
    from: string;
    roomId: string;
  }) => void;
}

// –°–æ–±—ã—Ç–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É
export interface ClientToServerEvents {
  // –ö–æ–º–Ω–∞—Ç—ã
  join_room: (payload: {
    roomId: string;
    userId: string;
    username: string;
  }) => void;

  leave_room: (payload: { roomId: string }) => void;

  // WebRTC signalling
  offer: (payload: {
    roomId: string;
    offer: RTCSessionDescriptionInit;
    to: string;
  }) => void;

  answer: (payload: {
    roomId: string;
    answer: RTCSessionDescriptionInit;
    to: string;
  }) => void;

  ice_candidate: (payload: {
    roomId: string;
    candidate: RTCIceCandidateInit;
    to: string;
  }) => void;
}

export interface ParticipantInfo {
  socketId: string;
  userId: string;
  username: string;
}

// –¢–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π socket
export type TypedSocket = Socket<ServerToClientEvents, ClientToServerEvents>;
```

---

### –®–∞–≥ 5: –û–±–Ω–æ–≤–∏—Ç—å socket.ts —Å —Ç–∏–ø–∞–º–∏

```typescript
// apps/client/src/lib/socket.ts
import { io, Socket } from 'socket.io-client';
import type { ServerToClientEvents, ClientToServerEvents } from '../types/socket';

const SOCKET_URL = import.meta.env.VITE_SOCKET_URL || 'http://localhost:3000';

export const socket: Socket<ServerToClientEvents, ClientToServerEvents> = io(
  SOCKET_URL,
  {
    withCredentials: true,
    autoConnect: false,
    reconnection: true,
    reconnectionAttempts: 5,
  },
);

export default socket;
```

---

## üìñ Socket.io Options

### withCredentials

**–ó–∞—á–µ–º:** –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å cookies —Å –∑–∞–ø—Ä–æ—Å–∞–º–∏

```typescript
withCredentials: true  // –í–∞–∂–Ω–æ –¥–ª—è JWT –≤ cookie
```

**–ë–µ–∑ —ç—Ç–æ–≥–æ:**
- HTTP-only cookie –Ω–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è
- JwtAuthGuard –Ω–µ —Å–º–æ–∂–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å

---

### autoConnect

```typescript
autoConnect: false  // –ù–µ –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è —Å—Ä–∞–∑—É
```

**–ó–∞—á–µ–º:** –ü–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è –≤—Ä—É—á–Ω—É—é –∫–æ–≥–¥–∞ –Ω—É–∂–Ω–æ

```typescript
// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
useEffect(() => {
  socket.connect();

  return () => {
    socket.disconnect();
  };
}, []);
```

---

### reconnection

```typescript
reconnection: true,
reconnectionAttempts: 5,
reconnectionDelay: 1000,        // –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
reconnectionDelayMax: 5000,     // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –ü—Ä–∏ disconnect –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
- –ó–∞–¥–µ—Ä–∂–∫–∞ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è —Å –∫–∞–∂–¥–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
- –ü–æ—Å–ª–µ 5 –ø–æ–ø—ã—Ç–æ–∫ ‚Äî stop

---

### timeout

```typescript
timeout: 20000  // 20 —Å–µ–∫—É–Ω–¥
```

**–ó–∞—á–µ–º:** –í—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞

---

## üéØ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ React

### –ë–∞–∑–æ–≤—ã–π —Ö—É–∫

```typescript
// apps/client/src/hooks/use-socket.ts
import { useEffect, useState } from 'react';
import { socket } from '../lib/socket';
import type { ServerToClientEvents } from '../types/socket';

export function useSocket() {
  const [isConnected, setIsConnected] = useState(socket.connected);

  useEffect(() => {
    function onConnect() {
      setIsConnected(true);
    }

    function onDisconnect() {
      setIsConnected(false);
    }

    socket.on('connect', onConnect);
    socket.on('disconnect', onDisconnect);

    return () => {
      socket.off('connect', onConnect);
      socket.off('disconnect', onDisconnect);
    };
  }, []);

  return { isConnected, socket };
}
```

---

### –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ

```typescript
import { useSocket } from '../hooks/use-socket';

export default function Lobby() {
  const { isConnected } = useSocket();

  useEffect(() => {
    // –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Socket.io
    socket.connect();

    return () => {
      socket.disconnect();
    };
  }, []);

  return (
    <div>
      <div className={isConnected ? 'text-green-500' : 'text-red-500'}>
        {isConnected ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É' : '–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ'}
      </div>
    </div>
  );
}
```

---

## ‚ö†Ô∏è –ù—é–∞–Ω—Å—ã –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. CORS –æ—à–∏–±–∫–∞

**–ü—Ä–æ–±–ª–µ–º–∞:**
```
Access to XMLHttpRequest has been blocked by CORS policy
```

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// –ö–ª–∏–µ–Ω—Ç
const socket = io('http://localhost:3000', {
  withCredentials: true,
});

// –°–µ—Ä–≤–µ—Ä
@WebSocketGateway({
  cors: {
    origin: ['http://localhost:5173'],
    credentials: true,
  },
})
```

---

### 2. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–ü—Ä–æ–±–ª–µ–º–∞:** –ö–∞–∂–¥—ã–π component mount —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

**–†–µ—à–µ–Ω–∏–µ:** Singleton pattern
```typescript
// apps/client/src/lib/socket.ts
export const socket = io(...); // Singleton!

// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö
import { socket } from '../lib/socket'; // –û–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –∏–Ω—Å—Ç–∞–Ω—Å
```

---

### 3. Memory leak –æ—Ç listeners

**–ü—Ä–æ–±–ª–µ–º–∞:** Listeners –Ω–µ —É–¥–∞–ª—è—é—Ç—Å—è –ø—Ä–∏ unmount

**–†–µ—à–µ–Ω–∏–µ:** Cleanup –≤ useEffect
```typescript
useEffect(() => {
  const handler = (data) => console.log(data);

  socket.on('event', handler);

  return () => {
    socket.off('event', handler); // –£–¥–∞–ª–∏—Ç—å listener
  };
}, []);
```

**–ò–ª–∏:**
```typescript
useEffect(() => {
  socket.on('event', handler);

  return () => {
    socket.off('event'); // –£–¥–∞–ª–∏—Ç—å –≤—Å–µ listeners –¥–ª—è 'event'
  };
}, []);
```

---

### 4. connect/disconnect race condition

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–±—ã—Ç–∏—è –¥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å socket.connected
```typescript
function sendMessage(message: string) {
  if (!socket.connected) {
    console.error('Socket –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω');
    return;
  }

  socket.emit('message', { message });
}
```

**–ò–ª–∏ callback:**
```typescript
socket.emit('message', data, (response) => {
  console.log('–û—Ç–≤–µ—Ç:', response);
});
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] Agora RTM —É–¥–∞–ª—ë–Ω –∏–∑ –ø—Ä–æ–µ–∫—Ç–∞
- [ ] socket.io-client —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
- [ ] Socket –∏–Ω—Å—Ç–∞–Ω—Å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç—Å—è –∏–∑ `lib/socket.ts`
- [ ] –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è Socket –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
- [ ] –í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞ –≤–∏–¥–Ω–æ "Socket –ø–æ–¥–∫–ª—é—á—ë–Ω: <socket-id>"
- [ ] –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ –≤–∏–¥–Ω–æ –ª–æ–≥ –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```typescript
// –í –ª—é–±–æ–º –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ
useEffect(() => {
  socket.connect();

  socket.on('connect', () => {
    console.log('Socket ID:', socket.id);
  });

  socket.on('ping', (data) => {
    console.log('Received ping:', data);
  });

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  socket.emit('ping', { message: 'test' });

  return () => {
    socket.disconnect();
  };
}, []);
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ reconnection

```typescript
// –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ —Å–µ—Ä–≤–µ—Ä ‚Äî –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
socket.on('reconnect', (attemptNumber) => {
  console.log('–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–æ –ø–æ—Å–ª–µ', attemptNumber, '–ø–æ–ø—ã—Ç–æ–∫');
});

socket.on('reconnect_attempt', (attemptNumber) => {
  console.log('–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', attemptNumber);
});
```

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 3.2: –ü–æ–ª—É—á–∏—Ç—å –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫](./3.2-media-stream.md)**

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è typed socket

```typescript
// apps/client/src/lib/socket-wrapper.ts
import { socket } from './socket';
import type { ServerToClientEvents, ClientToServerEvents } from '../types/socket';

class SocketWrapper {
  // –ö–æ–º–Ω–∞—Ç—ã
  joinRoom(payload: ClientToServerEvents['join_room']) {
    socket.emit('join_room', payload);
  }

  leaveRoom(payload: ClientToServerEvents['leave_room']) {
    socket.emit('leave_room', payload);
  }

  // WebRTC
  sendOffer(payload: ClientToServerEvents['offer']) {
    socket.emit('offer', payload);
  }

  sendAnswer(payload: ClientToServerEvents['answer']) {
    socket.emit('answer', payload);
  }

  sendIceCandidate(payload: ClientToServerEvents['ice_candidate']) {
    socket.emit('ice_candidate', payload);
  }

  // –ü–æ–¥–ø–∏—Å–∫–∞
  onParticipantList(callback: ServerToClientEvents['participants_list']) {
    socket.on('participants_list', callback);
  }

  offParticipantList(callback: ServerToClientEvents['participants_list']) {
    socket.off('participants_list', callback);
  }

  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
}

export const socketClient = new SocketWrapper();
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
import { socketClient } from '../lib/socket-wrapper';

socketClient.joinRoom({ roomId, userId, username });
```

---

### 2. React Query integration

```typescript
// apps/client/src/hooks/use-room-participants.ts
import { useQuery, useQueryClient } from '@tanstack/react-query';
import { socket } from '../lib/socket';

export function useRoomParticipants(roomId: string) {
  const queryClient = useQueryClient();

  useEffect(() => {
    const handleUpdate = (data: { participants: ParticipantInfo[] }) => {
      queryClient.setQueryData(['participants', roomId], data.participants);
    };

    socket.on('participants_list', handleUpdate);

    return () => {
      socket.off('participants_list', handleUpdate);
    };
  }, [roomId, queryClient]);

  return useQuery({
    queryKey: ['participants', roomId],
    queryFn: () => [],
    enabled: !!roomId,
  });
}
```

---

### 3. Socket.io Logger

```typescript
// apps/client/src/lib/socket-logger.ts
if (import.meta.env.DEV) {
  socket.onAny((event, ...args) => {
    console.log(`[Socket] ${event}`, ...args);
  });

  socket.onAnyOutgoing((event, ...args) => {
    console.log(`[Socket] ‚Üí ${event}`, ...args);
  });
}
```
