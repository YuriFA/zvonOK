# –ó–∞–¥–∞—á–∞ 3.2: –ü–æ–ª—É—á–∏—Ç—å –º–µ–¥–∏–∞-–ø–æ—Ç–æ–∫ (–∫–∞–º–µ—Ä–∞/–º–∏–∫—Ä–æ—Ñ–æ–Ω)

## –û–±–∑–æ—Ä

–ó–∞—Ö–≤–∞—Ç –∞—É–¥–∏–æ –∏ –≤–∏–¥–µ–æ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ MediaDevices API. –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –ø–æ—Ç–æ–∫–∞ –≤ video —ç–ª–µ–º–µ–Ω—Ç–µ.

---

## üéØ –¶–µ–ª—å

- `getUserMedia()` –ø–æ–ª—É—á–∞–µ—Ç –ø–æ—Ç–æ–∫ —Å –∫–∞–º–µ—Ä—ã/–º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
- –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ `<video>` —ç–ª–µ–º–µ–Ω—Ç–µ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–æ—Å—Ç—É–ø–∞
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º –∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[getUserMedia MDN](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**
   - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
   - –ü—Ä–∏–º–µ—Ä—ã

2. **[WebRTC adapters polyfill](https://github.com/webrtc/adapter)**
   - –ü–æ–ª–∏—Ñ–∏–ª–ª –¥–ª—è browser differences
   - –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[MediaStream API](https://developer.mozilla.org/en-US/docs/Web/API/MediaStream)**
- **[MediaTrackConstraints](https://developer.mozilla.org/en-US/docs/Web/API/MediaTrackConstraints)**

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å adapter (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

```bash
# –í apps/client/
pnpm add webrtc-adapter
```

**–ò–º–ø–æ—Ä—Ç –≤ `main.tsx`:**
```typescript
import 'webrtc-adapter';
```

**–ó–∞—á–µ–º:** –ò—Å–ø—Ä–∞–≤–ª—è–µ—Ç browser-specific —Ä–∞–∑–ª–∏—á–∏—è –≤ WebRTC API

---

### –®–∞–≥ 2: –ë–∞–∑–æ–≤—ã–π hook –¥–ª—è –º–µ–¥–∏–∞

**–í `apps/client/src/hooks/use-media-stream.ts`:**
```typescript
import { useState, useEffect, useRef } from 'react';

interface UseMediaStreamOptions {
  video?: boolean | MediaTrackConstraints;
  audio?: boolean | MediaTrackConstraints;
}

export function useMediaStream(options: UseMediaStreamOptions = {}) {
  const [stream, setStream] = useState<MediaStream | null>(null);
  const [error, setError] = useState<Error | null>(null);
  const [isLoading, setIsLoading] = useState(false);

  const startStream = async () => {
    setIsLoading(true);
    setError(null);

    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia({
        video: options.video ?? true,
        audio: options.audio ?? true,
      });

      setStream(mediaStream);
      return mediaStream;
    } catch (err) {
      const error = err as Error;
      setError(error);
      console.error('Error accessing media devices:', error);
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  const stopStream = () => {
    if (stream) {
      stream.getTracks().forEach(track => track.stop());
      setStream(null);
    }
  };

  // Cleanup –ø—Ä–∏ unmount
  useEffect(() => {
    return () => {
      stopStream();
    };
  }, [stream]);

  return {
    stream,
    error,
    isLoading,
    startStream,
    stopStream,
  };
}
```

---

### –®–∞–≥ 3: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤–∏–¥–µ–æ

**–í `apps/client/src/components/local-video.tsx`:**
```typescript
import { useEffect, useRef, RefObject } from 'react';

interface LocalVideoProps {
  stream: MediaStream | null;
  muted?: boolean;
  className?: string;
}

export function LocalVideo({ stream, muted = true, className }: LocalVideoProps) {
  const videoRef = useRef<HTMLVideoElement>(null);

  useEffect(() => {
    const videoElement = videoRef.current;
    if (!videoElement || !stream) return;

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–æ—Ç–æ–∫ –≤ video —ç–ª–µ–º–µ–Ω—Ç
    videoElement.srcObject = stream;

    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—å
    videoElement.play().catch(err => {
      console.error('Error playing video:', err);
    });

    return () => {
      // –û—á–∏—Å—Ç–∏—Ç—å –ø—Ä–∏ unmount
      if (videoElement.srcObject) {
        videoElement.srcObject = null;
      }
    };
  }, [stream]);

  if (!stream) {
    return (
      <div className={className}>
        <div className="flex items-center justify-center h-full bg-gray-800 text-white">
          –ù–µ—Ç –≤–∏–¥–µ–æ
        </div>
      </div>
    );
  }

  return (
    <video
      ref={videoRef}
      autoPlay
      playsInline
      muted={muted}
      className={className}
    />
  );
}
```

**–ü–æ—á–µ–º—É muted:**
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç feedback loop (—ç—Ö–æ)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ —Å–ª—ã—à–∏—Ç —Å–∞–º–æ–≥–æ —Å–µ–±—è
- –í–∞–∂–Ω–æ –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ video

---

### –®–∞–≥ 4: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ Room

**–í `apps/client/src/routes/room.tsx`:**
```typescript
import { useState, useEffect } from 'react';
import { useMediaStream } from '../hooks/use-media-stream';
import { LocalVideo } from '../components/local-video';

export default function RoomPage() {
  const [isVideoEnabled, setIsVideoEnabled] = useState(true);
  const [isAudioEnabled, setIsAudioEnabled] = useState(true);

  const { stream, error, isLoading, startStream, stopStream } = useMediaStream({
    video: isVideoEnabled ? {
      width: { ideal: 1280 },
      height: { ideal: 720 },
    } : false,
    audio: isAudioEnabled,
  });

  useEffect(() => {
    startStream();
  }, []);

  if (error) {
    return (
      <div className="p-4 bg-red-100 text-red-700">
        <h2 className="text-xl font-bold">–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–µ–¥–∏–∞</h2>
        <p>{error.name}: {error.message}</p>
        {error.name === 'NotAllowedError' && (
          <p className="mt-2">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É</p>
        )}
        {error.name === 'NotFoundError' && (
          <p className="mt-2">–ö–∞–º–µ—Ä–∞ –∏–ª–∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
        )}
      </div>
    );
  }

  if (isLoading) {
    return (
      <div className="p-4">
        <p>–ó–∞–ø—Ä–æ—Å –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É...</p>
      </div>
    );
  }

  return (
    <div className="p-4">
      <div className="mb-4 flex gap-2">
        <button
          onClick={() => {
            setIsVideoEnabled(!isVideoEnabled);
            // Restart stream —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
          }}
          className="px-4 py-2 bg-blue-500 text-white rounded"
        >
          {isVideoEnabled ? '–í—ã–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É' : '–í–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É'}
        </button>
        <button
          onClick={() => {
            setIsAudioEnabled(!isAudioEnabled);
            // Restart stream —Å –Ω–æ–≤—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
          }}
          className="px-4 py-2 bg-blue-500 text-white rounded"
        >
          {isAudioEnabled ? '–í—ã–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω' : '–í–∫–ª—é—á–∏—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω'}
        </button>
      </div>

      <LocalVideo
        stream={stream}
        className="w-full max-w-2xl rounded-lg bg-black"
      />
    </div>
  );
}
```

---

## üìñ MediaTrackConstraints

### –í–∏–¥–µ–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

```typescript
{
  video: {
    // –†–∞–∑–º–µ—Ä
    width: { min: 640, ideal: 1280, max: 1920 },
    height: { min: 480, ideal: 720, max: 1080 },

    // FPS
    frameRate: { ideal: 30, max: 60 },

    // –ö–∞–º–µ—Ä–∞ (front/back –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö)
    facingMode: 'user',       // –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è
    // facingMode: 'environment',  // –ó–∞–¥–Ω—è—è

    // Aspect ratio
    aspectRatio: 16 / 9,
  }
}
```

---

### –ê—É–¥–∏–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

```typescript
{
  audio: {
    // Echo cancellation
    echoCancellation: { ideal: true },

    // Noise suppression
    noiseSuppression: { ideal: true },

    // Auto gain control
    autoGainControl: { ideal: true },

    // Sample rate
    sampleRate: { ideal: 48000 },

    // Channel count (1 = mono, 2 = stereo)
    channelCount: { ideal: 2 },
  }
}
```

---

## ‚ö†Ô∏è –û—à–∏–±–∫–∏ –¥–æ—Å—Ç—É–ø–∞

### NotAllowedError

**–ü—Ä–∏—á–∏–Ω–∞:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –¥–æ—Å—Ç—É–ø

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```typescript
try {
  await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
} catch (err) {
  if (err.name === 'NotAllowedError') {
    // –ü–æ–∫–∞–∑–∞—Ç—å UI —Å –ø—Ä–æ—Å—å–±–æ–π —Ä–∞–∑—Ä–µ—à–∏—Ç—å
    showPermissionPrompt();
  }
}
```

---

### NotFoundError

**–ü—Ä–∏—á–∏–Ω–∞:** –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```typescript
if (err.name === 'NotFoundError') {
  // –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  showDeviceSelector();
}
```

---

### NotReadableError

**–ü—Ä–∏—á–∏–Ω–∞:** –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∑–∞–Ω—è—Ç–æ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º

**–û–±—Ä–∞–±–æ—Ç–∫–∞:**
```typescript
if (err.name === 'NotReadableError') {
  // –ó–∞–∫—Ä—ã—Ç—å –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É
  showErrorMessage('–ö–∞–º–µ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º');
}
```

---

## üîç –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

```typescript
async function getSupportedConstraints() {
  const supported = navigator.mediaDevices.getSupportedConstraints();

  console.log('Video width:', supported.width);
  console.log('Video height:', supported.height);
  console.log('Facing mode:', supported.facingMode);
  console.log('Echo cancellation:', supported.echoCancellation);
}
```

### –ü–æ–ª—É—á–∏—Ç—å capabilities —Ç—Ä–µ–∫–∞

```typescript
const stream = await navigator.mediaDevices.getUserMedia({ video: true });
const videoTrack = stream.getVideoTracks()[0];
const capabilities = videoTrack.getCapabilities();

console.log('Supported resolutions:', capabilities.width);
console.log('Supported frame rates:', capabilities.frameRate);
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] `getUserMedia()` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- [ ] –ë—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –¥–æ—Å—Ç—É–ø
- [ ] –õ–æ–∫–∞–ª—å–Ω–æ–µ –≤–∏–¥–µ–æ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –≤ video —ç–ª–µ–º–µ–Ω—Ç–µ
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–∏–¥–∏—Ç —Å–µ–±—è
- [ ] –ü—Ä–∏ –æ—Ç–∫–∞–∑–µ –≤ –¥–æ—Å—Ç—É–ø–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –æ—à–∏–±–∫–∞
- [ ] Stream –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ unmount

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –†–∞–∑–ª–∏—á–Ω—ã–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è

```typescript
// HD (1280x720)
{ width: 1280, height: 720 }

// Full HD (1920x1080)
{ width: 1920, height: 1080 }

// SD (640x480)
{ width: 640, height: 480 }
```

### 2. –¢–æ–ª—å–∫–æ –∞—É–¥–∏–æ

```typescript
const audioOnly = await navigator.mediaDevices.getUserMedia({
  video: false,
  audio: true,
});
```

### 3. –ú–æ–±–∏–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```typescript
// –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞
{ facingMode: 'user' }

// –ó–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
{ facingMode: 'environment' }

// –ö–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∫–∞–º–µ—Ä–∞ –ø–æ deviceId
{ deviceId: { exact: '...' } }
```

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 3.3: –°–æ–∑–¥–∞—Ç—å RTCPeerConnection](./3.3-rtc-peer-connection.md)**

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è bandwidth

```typescript
// –î–ª—è –º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞
const lowBandwidth = await navigator.mediaDevices.getUserMedia({
  video: {
    width: { ideal: 640 },
    height: { ideal: 480 },
    frameRate: { max: 15 },
  },
  audio: {
    sampleRate: 16000,  // –ë–æ–ª–µ–µ –Ω–∏–∑–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ
    channelCount: 1,    // Mono
  },
});
```

---

### 2. –í—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
const devices = await navigator.mediaDevices.enumerateDevices();
const videoDevices = devices.filter(d => d.kind === 'videoinput');

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
const stream = await navigator.mediaDevices.getUserMedia({
  video: {
    deviceId: { exact: videoDevices[0].deviceId },
  },
});
```

---

### 3. –ó–∞–ø–∏—Å—å –ø–æ—Ç–æ–∫–∞

```typescript
const mediaRecorder = new MediaRecorder(stream, {
  mimeType: 'video/webm;codecs=vp8',
  videoBitsPerSecond: 2500000, // 2.5 Mbps
});

mediaRecorder.ondataavailable = (event) => {
  if (event.data.size > 0) {
    // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —á–∞–Ω–∫
    chunks.push(event.data);
  }
};

mediaRecorder.start();
```

---

## üìã –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä hooks

```typescript
// apps/client/src/hooks/use-local-media.ts
import { useState, useEffect, useRef } from 'react';

export function useLocalMedia() {
  const [stream, setStream] = useState<MediaStream | null>(null);
  const [isVideoEnabled, setIsVideoEnabled] = useState(true);
  const [isAudioEnabled, setIsAudioEnabled] = useState(true);
  const videoTrackRef = useRef<MediaStreamTrack | null>(null);
  const audioTrackRef = useRef<MediaStreamTrack | null>(null);

  const startMedia = async () => {
    try {
      const mediaStream = await navigator.mediaDevices.getUserMedia({
        video: true,
        audio: true,
      });

      setStream(mediaStream);

      // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å refs
      videoTrackRef.current = mediaStream.getVideoTracks()[0];
      audioTrackRef.current = mediaStream.getAudioTracks()[0];
    } catch (err) {
      console.error('Failed to get media:', err);
      throw err;
    }
  };

  const toggleVideo = () => {
    if (videoTrackRef.current) {
      videoTrackRef.current.enabled = !videoTrackRef.current.enabled;
      setIsVideoEnabled(videoTrackRef.current.enabled);
    }
  };

  const toggleAudio = () => {
    if (audioTrackRef.current) {
      audioTrackRef.current.enabled = !audioTrackRef.current.enabled;
      setIsAudioEnabled(audioTrackRef.current.enabled);
    }
  };

  useEffect(() => {
    return () => {
      stream?.getTracks().forEach(track => track.stop());
    };
  }, [stream]);

  return {
    stream,
    isVideoEnabled,
    isAudioEnabled,
    startMedia,
    toggleVideo,
    toggleAudio,
  };
}
```
