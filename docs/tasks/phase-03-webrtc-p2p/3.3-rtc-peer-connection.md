# –ó–∞–¥–∞—á–∞ 3.3: –°–æ–∑–¥–∞—Ç—å RTCPeerConnection

## –û–±–∑–æ—Ä

–ù–∞—Å—Ç—Ä–æ–π–∫–∞ RTCPeerConnection –¥–ª—è P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö —Ç—Ä–µ–∫–æ–≤ –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –º–µ–¥–∏–∞-—Ç—Ä–µ–∫–æ–≤.

---

## üéØ –¶–µ–ª—å

- RTCPeerConnection —Å–æ–∑–¥–∞–Ω —Å STUN —Å–µ—Ä–≤–µ—Ä–∞–º–∏
- –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ peer connection
- ontrack –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Ç—Ä–µ–∫–∏
- onicecandidate –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —á–µ—Ä–µ–∑ signalling

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[RTCPeerConnection MDN](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection)**
   - –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –∏ –º–µ—Ç–æ–¥—ã
   - –°–æ–±—ã—Ç–∏—è

2. **[Perfect Negotiation pattern](https://developer.mozilla.org/en-US/docs/Web/API/WebRTC_API/Perfect_negotiation)**
   - –ò–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è –±–µ–∑ race conditions

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[ICE Configuration](https://developer.mozilla.org/en-US/docs/Web/API/RTCPeerConnection#RTCConfiguration_dictionary)**
- **[WebRTC Troubleshooting](https://webrtc.org/getting-started/troubleshooting)**

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ICE —Å–µ—Ä–≤–µ—Ä–æ–≤

**–í `apps/client/src/lib/config.ts`:**
```typescript
export const iceServers = {
  iceServers: [
    // Google Public STUN
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun2.l.google.com:19302' },
    { urls: 'stun:stun3.l.google.com:19302' },
    { urls: 'stun:stun4.l.google.com:19302' },

    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ STUN —Å–µ—Ä–≤–µ—Ä—ã
    { urls: 'stun:stun.qq.com:3478' },

    // TURN (–¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ)
    // {
    //   urls: 'turn:your-turn-server.com:3478',
    //   username: 'username',
    //   credential: 'password',
    // },
  ],
  iceTransportPolicy: 'all',  // 'relay' –¥–ª—è —Ç–æ–ª—å–∫–æ TURN
  iceCandidatePoolSize: 10,    // –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Å–±–æ—Ä –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
};
```

---

### –®–∞–≥ 2: Hook –¥–ª—è RTCPeerConnection

**–í `apps/client/src/hooks/use-peer-connection.ts`:**
```typescript
import { useRef, useCallback } from 'react';
import { socket } from '../lib/socket';
import { iceServers } from '../lib/config';

interface UsePeerConnectionOptions {
  localStream: MediaStream | null;
  onTrack: (event: RTCTrackEvent) => void;
  onIceCandidate: (candidate: RTCIceCandidate, targetSocketId: string) => void;
  remoteSocketId: string;
}

export function usePeerConnection({
  localStream,
  onTrack,
  onIceCandidate,
  remoteSocketId,
}: UsePeerConnectionOptions) {
  const peerConnection = useRef<RTCPeerConnection | null>(null);

  const createPeerConnection = useCallback(() => {
    console.log('Creating RTCPeerConnection with:', remoteSocketId);

    const pc = new RTCPeerConnection(iceServers);

    // –î–æ–±–∞–≤–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏
    if (localStream) {
      localStream.getTracks().forEach(track => {
        pc.addTrack(track, localStream);
        console.log('Added track:', track.kind, track.id);
      });
    }

    // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–µ–∫
    pc.ontrack = (event) => {
      console.log('Received track:', event.track.kind);
      onTrack(event);
    };

    // ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        console.log('ICE candidate:', event.candidate.type);
        onIceCandidate(event.candidate, remoteSocketId);
      } else {
        console.log('ICE gathering complete');
      }
    };

    // ICE connection state
    pc.oniceconnectionstatechange = () => {
      console.log('ICE state:', pc.iceConnectionState);

      if (pc.iceConnectionState === 'failed') {
        console.error('ICE connection failed');
        // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
      }
    };

    // Connection state
    pc.onconnectionstatechange = () => {
      console.log('Connection state:', pc.connectionState);
    };

    peerConnection.current = pc;
    return pc;
  }, [localStream, onTrack, onIceCandidate, remoteSocketId]);

  const closePeerConnection = useCallback(() => {
    if (peerConnection.current) {
      peerConnection.current.close();
      peerConnection.current = null;
    }
  }, []);

  return {
    peerConnection: peerConnection.current,
    createPeerConnection,
    closePeerConnection,
  };
}
```

---

### –®–∞–≥ 3: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è —É–¥–∞–ª—ë–Ω–Ω–æ–≥–æ –≤–∏–¥–µ–æ

**–í `apps/client/src/components/remote-video.tsx`:**
```typescript
import { useEffect, useRef, useState } from 'react';

interface RemoteVideoProps {
  stream: MediaStream | null;
  username?: string;
  className?: string;
}

export function RemoteVideo({ stream, username, className }: RemoteVideoProps) {
  const videoRef = useRef<HTMLVideoElement>(null);
  const [isPlaying, setIsPlaying] = useState(false);

  useEffect(() => {
    const videoElement = videoRef.current;
    if (!videoElement || !stream) return;

    videoElement.srcObject = stream;

    videoElement.onloadedmetadata = () => {
      videoElement.play().then(() => {
        setIsPlaying(true);
      }).catch(err => {
        console.error('Error playing remote video:', err);
      });
    };

    return () => {
      if (videoElement.srcObject) {
        const tracks = (videoElement.srcObject as MediaStream).getTracks();
        tracks.forEach(track => track.stop());
        videoElement.srcObject = null;
      }
      setIsPlaying(false);
    };
  }, [stream]);

  if (!stream) {
    return (
      <div className={className}>
        <div className="flex flex-col items-center justify-center h-full bg-gray-800 text-white">
          <svg className="w-16 h-16 mb-2" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
          </svg>
          <p>–û–∂–∏–¥–∞–Ω–∏–µ –≤–∏–¥–µ–æ...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="relative">
      <video
        ref={videoRef}
        autoPlay
        playsInline
        className={className}
      />
      {username && (
        <div className="absolute bottom-2 left-2 bg-black bg-opacity-50 text-white px-2 py-1 rounded">
          {username}
        </div>
      )}
      {!isPlaying && (
        <div className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-50 text-white">
          –ó–∞–≥—Ä—É–∑–∫–∞...
        </div>
      )}
    </div>
  );
}
```

---

## üìñ RTCPeerConnection —Å–æ–±—ã—Ç–∏—è

### ontrack

**–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞:** –£–¥–∞–ª—ë–Ω–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç —Ç—Ä–µ–∫

```typescript
pc.ontrack = (event) => {
  // event.track ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π —Ç—Ä–µ–∫ (–∞—É–¥–∏–æ –∏–ª–∏ –≤–∏–¥–µ–æ)
  // event.streams ‚Äî –º–∞—Å—Å–∏–≤ MediaStream

  const remoteStream = event.streams[0];

  // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤ video —ç–ª–µ–º–µ–Ω—Ç
  videoElement.srcObject = remoteStream;
};
```

**–í–∞–∂–Ω–æ:**
- ontrack —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ–∫–∞ –æ—Ç–¥–µ–ª—å–Ω–æ
- event.streams[0] —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ —Ç—Ä–µ–∫–∏ –æ—Ç —ç—Ç–æ–≥–æ peer connection
- –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ streams –ø—Ä–∏Êüê‰∫õ browsers

---

### onicecandidate

**–°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–≥–¥–∞:** –ù–∞–π–¥–µ–Ω –Ω–æ–≤—ã–π ICE –∫–∞–Ω–¥–∏–¥–∞—Ç

```typescript
pc.onicecandidate = (event) => {
  if (event.candidate) {
    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ—Ä–µ–∑ signalling
    socket.emit('ice_candidate', {
      candidate: event.candidate,
      to: remoteSocketId,
    });
  } else {
    // null –∫–∞–Ω–¥–∏–¥–∞—Ç = —Å–±–æ—Ä –∑–∞–≤–µ—Ä—à—ë–Ω
    console.log('ICE gathering complete');
  }
};
```

**–¢–∏–ø—ã –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤:**
- `host` ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–π IP
- `srflx` ‚Äî –ø—É–±–ª–∏—á–Ω—ã–π IP (—á–µ—Ä–µ–∑ STUN)
- `relay` ‚Äî TURN —Å–µ—Ä–≤–µ—Ä

---

### oniceconnectionstatechange

**–°–æ—Å—Ç–æ—è–Ω–∏—è:**
- `new` ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ–∑–¥–∞–Ω
- `checking` ‚Äî –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–Ω–¥–∏–¥–∞—Ç–æ–≤
- `connected` ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ
- `completed` ‚Äî –≤—Å–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω—ã
- `failed` ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å
- `disconnected` ‚Äî –ø–æ—Ç–µ—Ä—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è (–º–æ–∂–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è)
- `closed` ‚Äî —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ

```typescript
pc.oniceconnectionstatechange = () => {
  const state = pc.iceConnectionState;

  if (state === 'connected' || state === 'completed') {
    console.log('‚úÖ P2P —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ!');
  }

  if (state === 'failed') {
    console.error('‚ùå ICE connection failed');
    // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å recreate peer connection
  }
};
```

---

## ‚ö†Ô∏è –ù—é–∞–Ω—Å—ã –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–µ–∫–∏ –¥–æ createOffer

**–ü–ª–æ—Ö–æ:**
```typescript
const pc = new RTCPeerConnection(config);
const offer = await pc.createOffer();  // –ù–µ—Ç —Ç—Ä–µ–∫–æ–≤!
localStream.getTracks().forEach(track => pc.addTrack(track));
```

**–•–æ—Ä–æ—à–æ:**
```typescript
const pc = new RTCPeerConnection(config);
localStream.getTracks().forEach(track => pc.addTrack(track));
const offer = await pc.createOffer();  // SDP –≤–∫–ª—é—á–∞–µ—Ç —Ç—Ä–µ–∫–∏
```

---

### 2. –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ unmount

**–ü—Ä–æ–±–ª–µ–º–∞:** Peer connection –æ—Å—Ç–∞—ë—Ç—Å—è –∞–∫—Ç–∏–≤–Ω–æ–π

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
useEffect(() => {
  return () => {
    if (pc) {
      pc.close();
      // –ó–∞–∫—Ä—ã—Ç—å –≤—Å–µ —Ç—Ä–µ–∫–∏
      pc.getSenders().forEach(sender => {
        sender.track?.stop();
      });
      pc.getReceivers().forEach(receiver => {
        receiver.track?.stop();
      });
    }
  };
}, [pc]);
```

---

### 3. –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ peer connections

**–ü—Ä–æ–±–ª–µ–º–∞:** –î–ª—è N —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –Ω—É–∂–Ω–æ N peer connections

**–†–µ—à–µ–Ω–∏–µ:** Map –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è
```typescript
const peerConnections = useRef<Map<string, RTCPeerConnection>>(new Map());

const createPeerConnection = (socketId: string) => {
  const pc = new RTCPeerConnection(config);
  peerConnections.current.set(socketId, pc);
  return pc;
};

const getPeerConnection = (socketId: string) => {
  return peerConnections.current.get(socketId);
};
```

---

### 4. STUN –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–∏—á–∏–Ω—ã:**
- Symmetric NAT (–Ω—É–∂–µ–Ω TURN)
- Firewall –±–ª–æ–∫–∏—Ä—É–µ—Ç UDP
- –ù–µ–≤–µ—Ä–Ω—ã–π STUN —Å–µ—Ä–≤–µ—Ä

**–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:**
```typescript
pc.onicecandidateerror = (event) => {
  console.error('ICE candidate error:', {
    address: event.address,
    port: event.port,
    url: event.url,
    errorCode: event.errorCode,
  });
};
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] RTCPeerConnection —Å–æ–∑–¥–∞—ë—Ç—Å—è —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π ICE —Å–µ—Ä–≤–µ—Ä–æ–≤
- [ ] –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ peer connection
- [ ] ontrack –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Ç—Ä–µ–∫–∏
- [ ] onicecandidate –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–∞–Ω–¥–∏–¥–∞—Ç—ã —á–µ—Ä–µ–∑ signalling
- [ ] ICE connection state –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª–∏

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã

```typescript
const candidates: RTCIceCandidate[] = [];

pc.onicecandidate = (event) => {
  if (event.candidate) {
    candidates.push(event.candidate);
    console.log('Candidate:', {
      type: event.candidate.type,
      protocol: event.candidate.protocol,
      address: event.candidate.address,
      port: event.candidate.port,
    });
  } else {
    console.log('Total candidates:', candidates.length);
  }
};
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å sender/receiver

```typescript
// –ü–æ—Å–ª–µ addTrack
const senders = pc.getSenders();
console.log('Senders:', senders.map(s => ({
  kind: s.track?.kind,
  id: s.track?.id,
})));

// –ü–æ—Å–ª–µ ontrack
const receivers = pc.getReceivers();
console.log('Receivers:', receivers.map(r => ({
  kind: r.track?.kind,
  id: r.track?.id,
})));
```

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 3.4: Offer/Answer –æ–±–º–µ–Ω](./3.4-offer-answer.md)**

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. ICE restart –ø—Ä–∏ failed

```typescript
async function restartIce(pc: RTCPeerConnection) {
  const offer = await pc.createOffer({ iceRestart: true });
  await pc.setLocalDescription(offer);

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π offer
  socket.emit('offer', { offer, to: remoteSocketId });
}
```

---

### 2. Statistics API

```typescript
async function getStats(pc: RTCPeerConnection) {
  const stats = await pc.getStats(null);

  stats.forEach(report => {
    if (report.type === 'inbound-rtp' && report.mediaType === 'video') {
      console.log('Video stats:', {
        bytesReceived: report.bytesReceived,
        packetsReceived: report.packetsReceived,
        packetsLost: report.packetsLost,
        jitter: report.jitter,
      });
    }
  });
}

// –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
setInterval(() => getStats(pc), 1000);
```

---

### 3. Bitrate control

```typescript
// –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å bitrate
const sender = pc.getSenders().find(s => s.track?.kind === 'video');

if (sender) {
  const parameters = sender.getParameters();

  if (!parameters.encodings) {
    parameters.encodings = [{}];
  }

  parameters.encodings[0].maxBitrate = 500000; // 500 Kbps

  await sender.setParameters(parameters);
}
```

---

## üìã –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

```typescript
// –í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–µ Room
import { usePeerConnection } from '../hooks/use-peer-connection';
import { RemoteVideo } from '../components/remote-video';

export default function RoomPage() {
  const [remoteStream, setRemoteStream] = useState<MediaStream | null>(null);

  const handleTrack = (event: RTCTrackEvent) => {
    const stream = event.streams[0];
    if (stream) {
      setRemoteStream(stream);
    }
  };

  const handleIceCandidate = (candidate: RTCIceCandidate, targetSocketId: string) => {
    socket.emit('ice_candidate', {
      roomId,
      candidate,
      to: targetSocketId,
    });
  };

  const { peerConnection, createPeerConnection } = usePeerConnection({
    localStream,
    onTrack: handleTrack,
    onIceCandidate: handleIceCandidate,
    remoteSocketId: '...',
  });

  useEffect(() => {
    const pc = createPeerConnection();
    return () => pc.close();
  }, [createPeerConnection]);

  return (
    <div>
      <LocalVideo stream={localStream} />
      <RemoteVideo stream={remoteStream} username="Bob" />
    </div>
  );
}
```
