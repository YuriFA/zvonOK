# –ó–∞–¥–∞—á–∞ 1.4: –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Room

## –û–±–∑–æ—Ä

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–∏ "–ö–æ–º–Ω–∞—Ç–∞" –¥–ª—è –≤–∏–¥–µ–æ–∑–≤–æ–Ω–∫–æ–≤ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö. –ö–æ–º–Ω–∞—Ç—ã —Å–≤—è–∑—ã–≤–∞—é—Ç—Å—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ –æ—Ç–Ω–æ—à–µ–Ω–∏—è (relations).

---

## üéØ –¶–µ–ª—å

- –ú–æ–¥–µ–ª—å `Room` –≤ Prisma schema
- –°–≤—è–∑–∏ –º–µ–∂–¥—É `User` –∏ `Room` (–º–Ω–æ–≥–∏–µ-–∫–æ-–º–Ω–æ–≥–∏–º)
- Room –º–æ–∂–µ—Ç –∏–º–µ—Ç—å —Ö–æ—Å—Ç–∞ –∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ –∫ –ë–î

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[Prisma Relations](https://www.prisma.io/docs/concepts/components/prisma-schema/relations)**
   - One-to-many
   - Many-to-many
   - Self-relations

2. **[Prisma Schema Reference](https://www.prisma.io/docs/reference/api-reference/prisma-schema-reference)**
   - @relation
   - References

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[Database Normalization](https://www.guru99.com/database-normalization.html)**

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å schema.prisma

**–í `apps/server/prisma/schema.prisma`:**
```prisma
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  username     String
  password     String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  hostedRooms  Room[]   @relation("RoomHost")
  joinedRooms  Room[]   @relation("RoomParticipants")
}

model Room {
  id          String   @id @default(cuid())
  name        String?
  hostId      String
  host        User     @relation("RoomHost", fields: [hostId], references: [id], onDelete: Cascade)
  participants User[]   @relation("RoomParticipants")
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([hostId])
}
```

---

## üìñ –†–∞–∑–±–æ—Ä –æ—Ç–Ω–æ—à–µ–Ω–∏–π

### 1. @relation –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

**–°–∏–Ω—Ç–∞–∫—Å–∏—Å:**
```prisma
@relation("RelationName", fields: [foreignField], references: [idField])
```

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- `"RelationName"` ‚Äî –∏–º—è –æ—Ç–Ω–æ—à–µ–Ω–∏—è (–¥–æ–ª–∂–Ω–æ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –æ–±–µ–∏—Ö —Å—Ç–æ—Ä–æ–Ω)
- `fields: [hostId]` ‚Äî –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á –≤ —ç—Ç–æ–π –º–æ–¥–µ–ª–∏
- `references: [id]` ‚Äî primary key –≤ —Å–≤—è–∑–∞–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
- `onDelete: Cascade` ‚Äî —á—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏

---

### 2. One-to-Many (User ‚Üí Room –∫–∞–∫ —Ö–æ—Å—Ç)

```
User (1) -----> (N) Room
```

**–í User:**
```prisma
hostedRooms Room[] @relation("RoomHost")
```

**–í Room:**
```prisma
hostId String
host   User   @relation("RoomHost", fields: [hostId], references: [id])
```

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –û–¥–∏–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –±—ã—Ç—å —Ö–æ—Å—Ç–æ–º –º–Ω–æ–≥–∏—Ö –∫–æ–º–Ω–∞—Ç
- –£ –∫–∞–∂–¥–æ–π –∫–æ–º–Ω–∞—Ç—ã —Ä–æ–≤–Ω–æ –æ–¥–∏–Ω —Ö–æ—Å—Ç
- `hostId` ‚Äî –≤–Ω–µ—à–Ω–∏–π –∫–ª—é—á –Ω–∞ `User.id`

---

### 3. Many-to-Many (User ‚Üî Room –∫–∞–∫ —É—á–∞—Å—Ç–Ω–∏–∫–∏)

```
User (N) <----> (N) Room
```

**–í User:**
```prisma
joinedRooms Room[] @relation("RoomParticipants")
```

**–í Room:**
```prisma
participants User[] @relation("RoomParticipants")
```

**–ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞:**
Prisma –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—Å—Ç —Ç–∞–±–ª–∏—Ü—É `_RoomParticipants`:
```
| Room_id | User_id |
|---------|---------|
| clx...  | cly...  |
```

**–ù–µ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤—Ä—É—á–Ω—É—é!**

---

### 4. onDelete: Cascade

**–ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```prisma
host User @relation(..., onDelete: Cascade)
```

**Cascade:** –£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∫–æ–º–Ω–∞—Ç—ã, –≥–¥–µ —ç—Ç–æ—Ç user ‚Äî —Ö–æ—Å—Ç

**–í–∞—Ä–∏–∞–Ω—Ç—ã:**
- `Cascade` ‚Äî —É–¥–∞–ª–∏—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–ø–∏—Å–∏
- `SetNull` ‚Äî —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å null (—Ç—Ä–µ–±—É–µ—Ç nullable –ø–æ–ª–µ)
- `Restrict` ‚Äî –∑–∞–ø—Ä–µ—Ç–∏—Ç—å —É–¥–∞–ª–µ–Ω–∏–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)

---

### 5. @@index

```prisma
@@index([hostId])
```

**–ó–∞—á–µ–º:**
- –£—Å–∫–æ—Ä—è–µ—Ç –∑–∞–ø—Ä–æ—Å—ã —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ hostId
- Prisma –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è foreign keys –∏ unique
- –Ø–≤–Ω—ã–µ –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è —á–∞—Å—Ç—ã—Ö —Ñ–∏–ª—å—Ç—Ä–æ–≤

**–ü—Ä–∏–º–µ—Ä:**
```typescript
// –ë–µ–∑ –∏–Ω–¥–µ–∫—Å–∞ ‚Äî –ø–æ–ª–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä (O(n))
await prisma.room.findMany({ where: { hostId: '...' } });

// –° –∏–Ω–¥–µ–∫—Å–æ–º ‚Äî –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ (O(log n))
```

---

### –®–∞–≥ 2: –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é

```bash
# –í apps/server/
pnpm prisma migrate dev --name add-rooms
```

**–ß—Ç–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ:**
```sql
-- CreateTable
CREATE TABLE "Room" (
    "id" TEXT NOT NULL,
    "name" TEXT,
    "hostId" TEXT NOT NULL,
    "isActive" BOOLEAN NOT NULL DEFAULT true,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Room_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE INDEX "Room_hostId_idx" ON "Room"("hostId");

-- AddForeignKey
ALTER TABLE "Room" ADD CONSTRAINT "Room_hostId_fkey" FOREIGN KEY("hostId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- CreateTable (–¥–ª—è many-to-many)
CREATE TABLE "_RoomParticipants" (
    "A" TEXT NOT NULL,
    "B" TEXT NOT NULL
);
```

---

### –®–∞–≥ 3: –°–æ–∑–¥–∞—Ç—å Room Module

```bash
# –í apps/server/
nest g module room
nest g service room
nest g controller room
```

**–ß—Ç–æ —Å–æ–∑–¥–∞—Å—Ç—Å—è:**
```
apps/server/src/room/
‚îú‚îÄ‚îÄ room.module.ts
‚îú‚îÄ‚îÄ room.service.ts
‚îú‚îÄ‚îÄ room.controller.ts
‚îî‚îÄ‚îÄ dto/           (—Å–æ–∑–¥–∞–π –≤—Ä—É—á–Ω—É—é)
```

---

### –®–∞–≥ 4: RoomService

**–í `apps/server/src/room/room.service.ts`:**
```typescript
import { Injectable, NotFoundException } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';

@Injectable()
export class RoomService {
  constructor(private prisma: PrismaService) {}

  async createRoom(hostId: string, name?: string) {
    return this.prisma.room.create({
      data: {
        name,
        hostId,
      },
      include: {
        host: true,
        participants: true,
      },
    });
  }

  async getRoom(id: string) {
    const room = await this.prisma.room.findUnique({
      where: { id },
      include: {
        host: true,
        participants: true,
      },
    });

    if (!room) {
      throw new NotFoundException('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    return room;
  }

  async joinRoom(roomId: string, userId: string) {
    // –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏
    return this.prisma.room.update({
      where: { id: roomId },
      data: {
        participants: {
          connect: { id: userId },
        },
      },
      include: {
        host: true,
        participants: true,
      },
    });
  }

  async leaveRoom(roomId: string, userId: string) {
    return this.prisma.room.update({
      where: { id: roomId },
      data: {
        participants: {
          disconnect: { id: userId },
        },
      },
    });
  }

  async getUserRooms(userId: string) {
    return this.prisma.room.findMany({
      where: {
        OR: [
          { hostId: userId },
          { participants: { some: { id: userId } } },
        ],
      },
      include: {
        host: true,
        participants: true,
      },
    });
  }
}
```

---

## üéØ Prisma Relation API

### connect/disconnect

**–î–æ–±–∞–≤–∏—Ç—å —Å–≤—è–∑—å:**
```typescript
await prisma.room.update({
  where: { id: roomId },
  data: {
    participants: {
      connect: { id: userId },  // –î–æ–±–∞–≤–∏—Ç—å userId –≤ participants
    },
  },
});
```

**–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å:**
```typescript
await prisma.room.update({
  where: { id: roomId },
  data: {
    participants: {
      disconnect: { id: userId },  // –£–±—Ä–∞—Ç—å userId –∏–∑ participants
    },
  },
});
```

---

### set

**–ó–∞–º–µ–Ω–∏—Ç—å –≤—Å–µ—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:**
```typescript
await prisma.room.update({
  where: { id: roomId },
  data: {
    participants: {
      set: [{ id: userId1 }, { id: userId2 }],
    },
  },
});
```

---

### some/none/every

**–ù–∞–π—Ç–∏ –∫–æ–º–Ω–∞—Ç—ã –≥–¥–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—á–∞—Å—Ç–Ω–∏–∫:**
```typescript
await prisma.room.findMany({
  where: {
    participants: {
      some: { id: userId },  // —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫ —Å–æ–≤–ø–∞–¥–∞–µ—Ç
    },
  },
});
```

**–ù–∞–π—Ç–∏ –∫–æ–º–Ω–∞—Ç—ã –±–µ–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:**
```typescript
await prisma.room.findMany({
  where: {
    participants: {
      none: {},  // –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞
    },
  },
});
```

---

## ‚ö†Ô∏è –ù—é–∞–Ω—Å—ã –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. Circular dependencies

**–ü—Ä–æ–±–ª–µ–º–∞:** RoomModule –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç UserModule, UserModule –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç RoomModule

**–†–µ—à–µ–Ω–∏–µ:** –ò—Å–ø–æ–ª—å–∑—É–π `forwardRef()`
```typescript
import { forwardRef, Module } from '@nestjs/common';

@Module({
  imports: [forwardRef(() => RoomModule)],
})
export class UserModule {}
```

---

### 2. –ò–º–µ–Ω–∞ –æ—Ç–Ω–æ—à–µ–Ω–∏–π –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å

**–ü–ª–æ—Ö–æ:**
```prisma
// User
hostedRooms Room[] @relation("Host")

// Room
host User @relation("RoomHost", ...)
```

**–•–æ—Ä–æ—à–æ:**
```prisma
// –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º!
@relation("RoomHost")  // –≤ User
@relation("RoomHost")  // –≤ Room
```

---

### 3. Foreign key constraint

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ –º–æ–≥—É —Å–æ–∑–¥–∞—Ç—å Room —Å –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º userId

**–†–µ—à–µ–Ω–∏–µ:** –£–±–µ–¥–∏—Å—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
```typescript
async createRoom(hostId: string, name?: string) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
  const user = await this.prisma.user.findUnique({
    where: { id: hostId },
  });

  if (!user) {
    throw new NotFoundException('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
  }

  return this.prisma.room.create({
    data: { name, hostId },
  });
}
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] –ú–æ–¥–µ–ª—å Room –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤ schema.prisma
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ
- [ ] RoomModule —Å–æ–∑–¥–∞–Ω
- [ ] RoomService –∏–º–µ–µ—Ç –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–Ω–∞—Ç–∞–º–∏
- [ ] –ú–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É —á–µ—Ä–µ–∑ Prisma Studio

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Prisma Studio

```bash
pnpm prisma studio
```

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –°–æ–∑–¥–∞–π Room, –≤—ã–±–µ—Ä–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ User –∫–∞–∫ host
2. –î–æ–±–∞–≤—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —á–µ—Ä–µ–∑ —Ç–∞–±–ª–∏—Ü—É `_RoomParticipants`
3. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ —Å–≤—è–∑–∏ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 1.5: API –¥–ª—è –∫–æ–º–Ω–∞—Ç](./1.5-rooms-api.md)**

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

```prisma
model Room {
  maxParticipants Int @default(10)
  // ...
}
```

```typescript
async joinRoom(roomId: string, userId: string) {
  const room = await this.prisma.room.findUnique({
    where: { id: roomId },
    include: { participants: true },
  });

  if (room.participants.length >= room.maxParticipants) {
    throw new BadRequestException('–ö–æ–º–Ω–∞—Ç–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞');
  }

  // ...
}
```

---

### 2. –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π

```prisma
model Message {
  id        String   @id @default(cuid())
  content   String
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@index([roomId])
}

// –î–æ–±–∞–≤–∏—Ç—å –≤ Room
model Room {
  messages Message[]
}
```

---

### 3. –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ –∫–æ–º–Ω–∞—Ç—ã

```prisma
model Room {
  expiresAt DateTime?  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
}
```

```typescript
// Cron job –¥–ª—è –æ—á–∏—Å—Ç–∫–∏
@Cron('0 * * * *')  // –ö–∞–∂–¥—ã–π —á–∞—Å
async cleanExpiredRooms() {
  await this.prisma.room.deleteMany({
    where: {
      expiresAt: { lt: new Date() },
    },
  });
}
```
