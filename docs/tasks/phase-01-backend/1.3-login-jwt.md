# –ó–∞–¥–∞—á–∞ 1.3: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Ö–æ–¥ (JWT)

## –û–±–∑–æ—Ä

–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –≤—ã–¥–∞—á–µ–π JWT —Ç–æ–∫–µ–Ω–∞. –¢–æ–∫–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ HTTP-only cookie –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

---

## üéØ –¶–µ–ª—å

- Endpoint `POST /auth/login` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç email/–ø–∞—Ä–æ–ª—å
- –ü–∞—Ä–æ–ª–∏ —Å—Ä–∞–≤–Ω–∏–≤–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ bcrypt
- JWT —Ç–æ–∫–µ–Ω –≤—ã–¥–∞—ë—Ç—Å—è –≤ HTTP-only cookie
- –ó–∞—â–∏—â—ë–Ω–Ω—ã–µ endpoints —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[NestJS JWT Authentication](https://docs.nestjs.com/techniques/authentication#jwt-functionality)**
   - JWT —Å—Ç—Ä–∞—Ç–µ–≥–∏—è Passport
   - JwtAuthGuard

2. **[JWT.io](https://jwt.io/)**
   - –ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω JWT —Ç–æ–∫–µ–Ω
   - –°—Ç—Ä—É–∫—Ç—É—Ä–∞: header.payload.signature

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[HTTP-only Cookies](https://developer.mozilla.org/en-US/docs/Web/HTTP/Cookies)** ‚Äî –ø–æ—á–µ–º—É –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ
- **[Passport.js](http://www.passportjs.org/)** ‚Äî –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: JWT —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

**–í –ø—Ä–æ–µ–∫—Ç–µ —É–∂–µ –µ—Å—Ç—å:**
```json
{
  "@nestjs/jwt": "^10.0.0",
  "@nestjs/passport": "^10.0.0",
  "passport": "^0.6.0",
  "passport-jwt": "^4.0.0"
}
```

**–ï—Å–ª–∏ –Ω–µ—Ç, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å:**
```bash
pnpm add @nestjs/jwt @nestjs/passport passport passport-jwt
pnpm add -D @types/passport-jwt
```

---

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ JWT

**–í `apps/server/.env.development`:**
```env
JWT_SECRET=your-super-secret-key-change-in-production
JWT_EXPIRES_IN=24h
```

**–í–∞–∂–Ω–æ:**
- `JWT_SECRET` –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º –∏ —Å–ª—É—á–∞–π–Ω—ã–º
- –í –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π –º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞
- –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å –≤ git!

---

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ AuthService

**–í `apps/server/src/auth/auth.service.ts`:**
```typescript
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { PrismaService } from '../prisma/prisma.service';
import * as bcrypt from 'bcrypt';

export class LoginDto {
  @IsEmail()
  email: string;

  @IsString()
  password: string;
}

@Injectable()
export class AuthService {
  constructor(
    private prisma: PrismaService,
    private jwtService: JwtService,
  ) {}

  async login(email: string, password: string) {
    // 1. –ù–∞–π—Ç–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await this.prisma.user.findUnique({
      where: { email },
    });

    if (!user) {
      throw new UnauthorizedException('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
    }

    // 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞—Ä–æ–ª—å
    const passwordValid = await bcrypt.compare(password, user.password);

    if (!passwordValid) {
      throw new UnauthorizedException('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
    }

    // 3. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å JWT
    const payload = { sub: user.id, email: user.email };
    const token = this.jwtService.sign(payload);

    // 4. –í–µ—Ä–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–±–µ–∑ –ø–∞—Ä–æ–ª—è)
    return {
      user: {
        id: user.id,
        email: user.email,
        username: user.username,
      },
      token,  // –í—Ä–µ–º–µ–Ω–Ω–æ, –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    };
  }

  // ... register method
}
```

**JWT Payload:**
```json
{
  "sub": "user-id",      // Subject (–∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
  "email": "user@email", // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  "iat": 1234567890,     // Issued At (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
  "exp": 1234654290      // Expiration (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
}
```

---

### –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ AuthController

**–í `apps/server/src/auth/auth.controller.ts`:**
```typescript
import { Body, Controller, Post, Res, HttpStatus, UsePipes, ValidationPipe } from '@nestjs/common';
import { Response } from 'express';
import { AuthService } from './auth.service';
import { LoginDto } from './dto/login.dto';

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @Post('login')
  @UsePipes(new ValidationPipe({ whitelist: true, forbidNonWhitelisted: true }))
  async login(@Body() dto: LoginDto, @Res() res: Response) {
    const result = await this.authService.login(dto.email, dto.password);

    // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å HTTP-only cookie
    res.cookie('auth_token', result.token, {
      httpOnly: true,      // –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript
      secure: false,       // true –¥–ª—è HTTPS (–≤ –ø—Ä–æ–¥–µ)
      sameSite: 'lax',     // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
      maxAge: 24 * 60 * 60 * 1000, // 24 —á–∞—Å–∞ –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
      path: '/',
    });

    // –í–µ—Ä–Ω—É—Ç—å —Ç–æ–ª—å–∫–æ user (—Ç–æ–∫–µ–Ω –≤ cookie)
    res.status(HttpStatus.OK).json(result.user);
  }

  @Post('logout')
  @HttpCode(HttpStatus.OK)
  async logout(@Res() res: Response) {
    res.clearCookie('auth_token', {
      path: '/',
    });

    res.status(HttpStatus.OK).json({ message: 'Logged out successfully' });
  }

  // ... register endpoint
}
```

---

### –®–∞–≥ 5: JWT Strategy

**–í `apps/server/src/auth/strategies/jwt.strategy.ts`:**
```typescript
import { Injectable, UnauthorizedException } from '@nestjs/common';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { PrismaService } from '../../prisma/prisma.service';

@Injectable()
export class JwtStrategy extends PassportStrategy(Strategy) {
  constructor(private prisma: PrismaService) {
    super({
      // –ò–∑–≤–ª–µ—á—å —Ç–æ–∫–µ–Ω –∏–∑ cookie
      jwtFromRequest: ExtractJwt.fromExtractors([
        (request) => {
          return request?.cookies?.auth_token;
        },
      ]),
      ignoreExpiration: false,
      secretOrKey: process.env.JWT_SECRET,
    });
  }

  async validate(payload: { sub: string; email: string }) {
    // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
    const user = await this.prisma.user.findUnique({
      where: { id: payload.sub },
      select: {
        id: true,
        email: true,
        username: true,
      },
    });

    if (!user) {
      throw new UnauthorizedException();
    }

    return user;  // –ë—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ req.user
  }
}
```

---

### –®–∞–≥ 6: JWT Guard

**–í `apps/server/src/auth/guards/jwt-auth.guard.ts`:**
```typescript
import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class JwtAuthGuard extends AuthGuard('jwt') {}
```

**–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π:**
```typescript
import { UseGuards } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@UseGuards(AuthGuard('jwt'))
async protectedEndpoint() {
  // req.user –¥–æ—Å—Ç—É–ø–µ–Ω –∑–¥–µ—Å—å
}
```

---

### –®–∞–≥ 7: –ó–∞—â–∏—Ç–∞ endpoint

**–í `apps/server/src/auth/auth.controller.ts`:**
```typescript
import { UseGuards } from '@nestjs/common';
import { JwtAuthGuard } from './guards/jwt-auth.guard';

@Controller('auth')
export class AuthController {
  @Get('profile')
  @UseGuards(JwtAuthGuard)
  getProfile(@Request() req) {
    // req.user —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ JWT strategy
    return req.user;
  }
}
```

**–î–µ–∫–æ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```typescript
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext) => {
    const request = ctx.switchToHttp().getRequest();
    return request.user;
  },
);

// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
@Get('profile')
@UseGuards(JwtAuthGuard)
getProfile(@CurrentUser() user: any) {
  return user;
}
```

---

## üç™ HTTP-only Cookies

### –ó–∞—á–µ–º?

**–ë–µ–∑ cookie:**
```javascript
// –¢–æ–∫–µ–Ω –≤ localStorage –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ª—é–±–æ–≥–æ JS
localStorage.setItem('token', 'eyJhbG...');

// XSS –∞—Ç–∞–∫–∞ –º–æ–∂–µ—Ç —É–∫—Ä–∞—Å—Ç—å —Ç–æ–∫–µ–Ω
const stolen = localStorage.getItem('token');
```

**–° HTTP-only cookie:**
```javascript
// –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript
document.cookie; // "auth_token=..." –Ω–µ –≤–∏–¥–µ–Ω

// –¢–æ–ª—å–∫–æ –±—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç cookie
```

**–ü–ª—é—Å—ã:**
- ‚úì –ó–∞—â–∏—Ç–∞ –æ—Ç XSS –∞—Ç–∞–∫
- ‚úì –ë—Ä–∞—É–∑–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç
- ‚úì –ú–æ–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Secure –∏ SameSite

**–ú–∏–Ω—É—Å—ã:**
- ‚úó CSRF –∞—Ç–∞–∫–∏ –≤–æ–∑–º–æ–∂–Ω—ã (–Ω–æ mitigates —á–µ—Ä–µ–∑ SameSite)
- ‚úó –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∏–∑ JavaScript (–Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π endpoint)

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å JWT

### 1. –ù–µ —Ö—Ä–∞–Ω–∏–º —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–æ–∫–µ–Ω–µ

**–ü–ª–æ—Ö–æ:**
```json
{
  "sub": "user-id",
  "password": "hashed_password",  // –ù–µ—Ç! –ù–µ—Ç! –ù–µ—Ç!
  "creditCard": "1234..."
}
```

**–•–æ—Ä–æ—à–æ:**
```json
{
  "sub": "user-id",
  "email": "user@example.com"  // –¢–æ–ª—å–∫–æ ID –∏–ª–∏ email
}
```

**–ü–æ—á–µ–º—É:** JWT —Ç–æ–∫–µ–Ω—ã –Ω–µ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã, —Ç–æ–ª—å–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω—ã. –õ—é–±–æ–π –º–æ–∂–µ—Ç –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞—Ç—å –∏ –ø—Ä–æ—á–∏—Ç–∞—Ç—å.

---

### 2. –í—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Ç–æ–∫–µ–Ω–∞

**Access token (–∫–æ—Ä–æ—Ç–∫–∏–π):**
```env
JWT_EXPIRES_IN=15m
```

**Refresh token (–¥–ª–∏–Ω–Ω—ã–π):**
```typescript
// –û—Ç–¥–µ–ª—å–Ω—ã–π endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
@Post('refresh')
async refresh(@Cookie('refresh_token') refreshToken: string) {
  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å refresh token
  // –í—ã–¥–∞—Ç—å –Ω–æ–≤—ã–π access token
}
```

---

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–æ–ª–µ–π

**–ò—Å–ø–æ–ª—å–∑—É–π bcrypt.compare(), –∞ –Ω–µ ===:**
```typescript
// –ü–ª–æ—Ö–æ
if (user.password === inputPassword) { }

// –•–æ—Ä–æ—à–æ
const isValid = await bcrypt.compare(inputPassword, user.password);
```

---

## ‚ö†Ô∏è –ù—é–∞–Ω—Å—ã –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. Generic error message

**–í—Å–µ–≥–¥–∞ —Å–∫—Ä—ã–≤–∞–π —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:**

**–ü–ª–æ—Ö–æ:**
```typescript
if (!user) {
  throw new UnauthorizedException('Email –Ω–µ –Ω–∞–π–¥–µ–Ω');
}
if (!passwordValid) {
  throw new UnauthorizedException('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å');
}
```

**–•–æ—Ä–æ—à–æ:**
```typescript
if (!user || !passwordValid) {
  throw new UnauthorizedException('–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å');
}
```

**–ü–æ—á–µ–º—É:** –≠—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–µ—Ä–µ–±–æ—Ä–∞ email –∞–¥—Ä–µ—Å–æ–≤.

---

### 2. Cookie –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è

**–ü—Ä–∏—á–∏–Ω—ã:**
- `secure: true` –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (–Ω—É–∂–µ–Ω HTTPS)
- –ù–µ–≤–µ—Ä–Ω—ã–π `path`
- –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ third-party cookies

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
res.cookie('auth_token', token, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',  // –¢–æ–ª—å–∫–æ –≤ –ø—Ä–æ–¥–µ
  sameSite: 'lax',
  maxAge: 24 * 60 * 60 * 1000,
  path: '/',
});
```

---

### 3. req.user undefined

**–ü—Ä–∏—á–∏–Ω–∞:** JwtStrategy –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ

**–†–µ—à–µ–Ω–∏–µ:**
```typescript
// JwtStrategy
async validate(payload) {
  return { id: payload.sub, email: payload.email };  // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ return!
}
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] `POST /auth/login` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–∫–µ–Ω –≤ cookie
- [ ] –ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401
- [ ] –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π email –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401
- [ ] –ó–∞—â–∏—â—ë–Ω–Ω—ã–π endpoint —Ç—Ä–µ–±—É–µ—Ç —Ç–æ–∫–µ–Ω–∞
- [ ] –¢–æ–∫–µ–Ω –≤ cookie –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –í–æ–π—Ç–∏

```bash
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -c cookies.txt \
  -d '{
    "email": "test@test.com",
    "password": "123456"
  }' \
  -v
```

**–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤ –≤—ã–≤–æ–¥–µ:**
```
< Set-Cookie: auth_token=eyJhbG...; Path=/; HttpOnly
```

### 2. –î–æ—Å—Ç—É–ø –∫ –∑–∞—â–∏—â—ë–Ω–Ω–æ–º—É —Ä–µ—Å—É—Ä—Å—É

```bash
curl http://localhost:3000/auth/profile \
  -b cookies.txt \
  -v
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ cookie –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ JS

**–í –∫–æ–Ω—Å–æ–ª–∏ –±—Ä–∞—É–∑–µ—Ä–∞:**
```javascript
document.cookie;  // auth_token –Ω–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∏–¥–µ–Ω
```

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 1.4: –°–æ–∑–¥–∞—Ç—å –º–æ–¥–µ–ª—å Room](./1.4-room-model.md)**

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. Refresh tokens

```typescript
async login(email: string, password: string) {
  // ... –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

  const accessToken = this.jwtService.sign({ sub: user.id });
  const refreshToken = crypto.randomBytes(32).toString('hex');

  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å refresh token –≤ –ë–î
  await this.prisma.refreshToken.create({
    data: {
      token: refreshToken,
      userId: user.id,
      expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 –¥–Ω–µ–π
    },
  });

  return { accessToken, refreshToken };
}
```

---

### 2. Logout —Å –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π —Ç–æ–∫–µ–Ω–∞

```typescript
@Post('logout')
@UseGuards(JwtAuthGuard)
async logout(@CurrentUser() user: any, @Res() res: Response) {
  // –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–∫–µ–Ω –≤ —á—ë—Ä–Ω—ã–π —Å–ø–∏—Å–æ–∫ (Redis)
  await this.redis.set(`blacklist:${user.token}`, '1', 'EX', 24 * 60 * 60);

  res.clearCookie('auth_token');
  res.status(200).json({ message: 'Logged out' });
}
```

---

### 3. JWT –≤ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (stateless)

**–ö–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏:**
```typescript
const token = this.jwtService.sign(payload, {
  expiresIn: '15m',
});
```

**–ü–ª—é—Å—ã:**
- –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–∏ logout (—á–µ—Ä–µ–∑ blacklist)
- –ú–µ–Ω—å—à–µ —Ä–∏—Å–∫–∞ –ø—Ä–∏ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏
