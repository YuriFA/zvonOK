# –ó–∞–¥–∞—á–∞ 1.2: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é

## –û–±–∑–æ—Ä

–°–æ–∑–¥–∞–Ω–∏–µ endpoint –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–∞—Ä–æ–ª–µ–π —á–µ—Ä–µ–∑ bcrypt.

---

## üéØ –¶–µ–ª—å

- Endpoint `POST /auth/register` —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
- –ü–∞—Ä–æ–ª–∏ –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ bcrypt
- –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ DTO
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (–¥—É–±–ª–∏–∫–∞—Ç email)

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[NestJS Custom Providers](https://docs.nestjs.com/fundamentals/custom-providers)**
   - –ö–∞–∫ –≤–Ω–µ–¥—Ä—è—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

2. **[NestJS Validation](https://docs.nestjs.com/techniques/validation)**
   - class-validator –¥–ª—è DTO
   - class-transformer

3. **[bcrypt npm](https://www.npmjs.com/package/bcrypt)**
   - –•–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–æ–ª–µ–π
   - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Ö–µ—à–µ–π

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[Password Hashing Best Practices](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)**
- **[NestJS Exception Filters](https://docs.nestjs.com/exception-filters)**

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
# –í apps/server/
pnpm add bcrypt
pnpm add -D @types/bcrypt

# –î–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (–µ—Å–ª–∏ –µ—â—ë –Ω–µ—Ç)
pnpm add class-validator class-transformer
```

**–í–∫–ª—é—á–∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é –≥–ª–æ–±–∞–ª—å–Ω–æ –≤ `main.ts`:**
```typescript
import { ValidationPipe } from '@nestjs/common';

async function bootstrap() {
  const app = await NestFactory.create(AppModule);

  app.useGlobalPipes(new ValidationPipe({
    whitelist: true,        // –£–¥–∞–ª—è—Ç—å —Å–≤–æ–π—Å—Ç–≤–∞ –±–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä–æ–≤
    forbidNonWhitelisted: true,  // –û—à–∏–±–∫–∞ –µ—Å–ª–∏ –µ—Å—Ç—å –ª–∏—à–Ω–∏–µ —Å–≤–æ–π—Å—Ç–≤–∞
    transform: true,        // –ü—Ä–µ–≤—Ä–∞—â–∞—Ç—å query params –≤ —Ç–∏–ø—ã DTO
  }));

  await app.listen(3000);
}
```

---

### –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ DTO

**–í `apps/server/src/auth/dto/register.dto.ts`:**
```typescript
import { IsEmail, IsString, MinLength, MaxLength } from 'class-validator';

export class RegisterDto {
  @IsEmail({}, { message: '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π email' })
  email: string;

  @IsString()
  @MinLength(3, { message: '–ò–º—è –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞' })
  @MaxLength(20, { message: '–ò–º—è –º–∞–∫—Å–∏–º—É–º 20 —Å–∏–º–≤–æ–ª–æ–≤' })
  username: string;

  @IsString()
  @MinLength(6, { message: '–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤' })
  password: string;
}
```

**–î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏:**
- `@IsEmail()` ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç email
- `@IsString()` ‚Äî —Å—Ç—Ä–æ–∫–∞
- `@MinLength(n)` ‚Äî –º–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞
- `@MaxLength(n)` ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞

---

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ AuthService

**–í `apps/server/src/auth/auth.service.ts`:**
```typescript
import { Injectable, ConflictException } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { PrismaService } from '../prisma/prisma.service';
import { RegisterDto } from './dto/register.dto';
import * as bcrypt from 'bcrypt';

@Injectable()
export class AuthService {
  constructor(
    private prisma: PrismaService,
    private jwtService: JwtService,
  ) {}

  async register(dto: RegisterDto) {
    // 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ email –Ω–µ –∑–∞–Ω—è—Ç
    const existingUser = await this.prisma.user.findUnique({
      where: { email: dto.email },
    });

    if (existingUser) {
      throw new ConflictException('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
    }

    // 2. –ó–∞—Ö–µ—à–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å
    const hashedPassword = await bcrypt.hash(dto.password, 10);

    // 3. –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = await this.prisma.user.create({
      data: {
        email: dto.email,
        username: dto.username,
        password: hashedPassword,
      },
      // –ù–µ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–∞—Ä–æ–ª—å –≤ –æ—Ç–≤–µ—Ç–µ
      select: {
        id: true,
        email: true,
        username: true,
        createdAt: true,
      },
    });

    return user;
  }

  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ (login, etc)
}
```

---

### –®–∞–≥ 4: –î–æ–±–∞–≤–ª–µ–Ω–∏–µ endpoint –≤ AuthController

**–í `apps/server/src/auth/auth.controller.ts`:**
```typescript
import { Body, Controller, Post, HttpCode, HttpStatus } from '@nestjs/common';
import { AuthService } from './auth.service';
import { RegisterDto } from './dto/register.dto';

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @Post('register')
  @HttpCode(HttpStatus.CREATED)
  async register(@Body() dto: RegisterDto) {
    return this.authService.register(dto);
  }

  // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ endpoints
}
```

**–ö–æ–¥—ã –æ—Ç–≤–µ—Ç–∞:**
- `201 CREATED` ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω
- `400 BAD REQUEST` ‚Äî –æ—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `409 CONFLICT` ‚Äî email —É–∂–µ –∑–∞–Ω—è—Ç

---

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

**–ß–µ—Ä–µ–∑ curl:**
```bash
curl -X POST http://localhost:3000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@test.com",
    "username": "testuser",
    "password": "123456"
  }'
```

**–û–∂–∏–¥–∞–µ–º—ã–π –æ—Ç–≤–µ—Ç (201):**
```json
{
  "id": "clx...",
  "email": "test@test.com",
  "username": "testuser",
  "createdAt": "2024-01-24T10:00:00.000Z"
}
```

**–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ (400):**
```json
{
  "statusCode": 400,
  "message": [
    "email must be an email",
    "password must be longer than or equal to 6 characters"
  ],
  "error": "Bad Request"
}
```

**–û—à–∏–±–∫–∞ –¥—É–±–ª–∏–∫–∞—Ç–∞ (409):**
```json
{
  "statusCode": 409,
  "message": "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç",
  "error": "Conflict"
}
```

---

## üîê –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### bcrypt rounds (cost factor)

```typescript
await bcrypt.hash(password, 10);
```

**–ß—Ç–æ —ç—Ç–æ:** –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏—Ç–µ—Ä–∞—Ü–∏–π —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è.

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- `10` ‚Äî —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–∑–∞–Ω–∏–º–∞–µ—Ç ~100–º—Å)
- `12` ‚Äî –±–æ–ª–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ, –Ω–æ –º–µ–¥–ª–µ–Ω–Ω–µ–µ (~400–º—Å)
- `8` ‚Äî –±—ã—Å—Ç—Ä–µ–µ, –Ω–æ –º–µ–Ω–µ–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ (~50–º—Å)

**–ö–∞–∫ –≤—ã–±—Ä–∞—Ç—å:**
- –ë–∞–ª–∞–Ω—Å –º–µ–∂–¥—É –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é
- 10 –æ–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

---

### –ó–∞—â–∏—Ç–∞ –æ—Ç rainbow tables

**bcrypt –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:**
- –î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–ª—å (salt)
- –ö–∞–∂–¥–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞—ë—Ç —Ä–∞–∑–Ω—ã–π —Ö–µ—à –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–∞—Ä–æ–ª—è

```typescript
await bcrypt.hash('password', 10);  // "$2b$10$..."
await bcrypt.hash('password', 10);  // "$2b$10$..." (–¥—Ä—É–≥–æ–π!)
```

---

## ‚ö†Ô∏è –ù—é–∞–Ω—Å—ã –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. –ù–µ–ª—å–∑—è –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –ø–∞—Ä–æ–ª—å –≤ –æ—Ç–≤–µ—Ç–µ

**–ü–ª–æ—Ö–æ:**
```typescript
const user = await this.prisma.user.create({ data: dto });
return user;  // –í–∫–ª—é—á–∞–µ—Ç –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å!
```

**–•–æ—Ä–æ—à–æ:**
```typescript
const user = await this.prisma.user.create({
  data: dto,
  select: {
    id: true,
    email: true,
    username: true,
    // password –Ω–µ —É–∫–∞–∑–∞–Ω ‚Üí –Ω–µ –≤–µ—Ä–Ω—ë—Ç—Å—è
  },
});
```

**–ò–ª–∏ —á–µ—Ä–µ–∑ Prisma API:**
```typescript
// –ò—Å–∫–ª—é—á–∏—Ç—å –ø–∞—Ä–æ–ª—å –∏–∑ –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
export const UserWithoutPassword = Prisma.validator<Prisma.UserArgs>()({
  select: {
    id: true,
    email: true,
    username: true,
    createdAt: true,
  },
});
```

---

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ Prisma

**Prisma –≤—ã–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ—à–∏–±–∫–∏:**

```typescript
import { Prisma } from '@prisma/client';

try {
  await this.prisma.user.create({ data: dto });
} catch (error) {
  if (error instanceof Prisma.PrismaClientKnownRequestError) {
    // P2002: Unique constraint violation
    if (error.code === 'P2002') {
      throw new ConflictException('Email —É–∂–µ –∑–∞–Ω—è—Ç');
    }
  }
  throw error;
}
```

**–ö–æ–¥—ã –æ—à–∏–±–æ–∫ Prisma:**
- `P2002` ‚Äî —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –Ω–∞—Ä—É—à–µ–Ω–∞ (duplicate key)
- `P2025` ‚Äî –∑–∞–ø–∏—Å—å –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

---

### 3. –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

**Prisma schema:**
```prisma
model User {
  email String @unique
}
```

**–≠—Ç–æ:**
- –°–æ–∑–¥–∞—ë—Ç UNIQUE –∏–Ω–¥–µ–∫—Å
- –ë–î —Å–∞–º–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã
- –ó–∞—â–∏—Ç–∞ –æ—Ç race conditions

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] `POST /auth/register` —Å–æ–∑–¥–∞—ë—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –ü–∞—Ä–æ–ª—å –∑–∞—Ö–µ—à–∏—Ä–æ–≤–∞–Ω (–ø—Ä–æ–≤–µ—Ä—å –≤ –ë–î —á–µ—Ä–µ–∑ Prisma Studio)
- [ ] –î—É–±–ª–∏–∫–∞—Ç email –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 409
- [ ] –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 400
- [ ] –ü–∞—Ä–æ–ª—å –Ω–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –≤ –æ—Ç–≤–µ—Ç–µ

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 1.3: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Ö–æ–¥ (JWT)](./1.3-login-jwt.md)**

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ email

```typescript
// –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
const verificationToken = crypto.randomBytes(32).toString('hex');

await this.prisma.user.create({
  data: {
    ...dto,
    verificationToken,
  },
});

// –û—Ç–ø—Ä–∞–≤–∏—Ç—å email —Å —Å—Å—ã–ª–∫–æ–π
await this.emailService.sendVerificationEmail(dto.email, verificationToken);
```

---

### 2. Rate limiting

**–ó–∞—â–∏—Ç–∞ –æ—Ç –±—Ä—É—Ç—Ñ–æ—Ä—Å–∞:**
```bash
pnpm add @nestjs/throttler
```

```typescript
import { ThrottlerModule } from '@nestjs/throttler';

@Module({
  imports: [
    ThrottlerModule.forRoot([{
      ttl: 60000,      // 60 —Å–µ–∫—É–Ω–¥
      limit: 5,        // 5 –∑–∞–ø—Ä–æ—Å–æ–≤
    }]),
  ],
})
```

---

### 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ø—ã—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

```typescript
await this.prisma.registrationLog.create({
  data: {
    email: dto.email,
    ip: request.ip,
    userAgent: request.headers['user-agent'],
    success: true,
  },
});
```
