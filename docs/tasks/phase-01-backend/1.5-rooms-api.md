# –ó–∞–¥–∞—á–∞ 1.5: API –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/–ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –∫–æ–º–Ω–∞—Ç–∞–º

## –û–±–∑–æ—Ä

REST API endpoints –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–º–Ω–∞—Ç–∞–º–∏. –°–æ–∑–¥–∞–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä, –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–∞–º —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π.

---

## üéØ –¶–µ–ª—å

- `POST /rooms` ‚Äî —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É (—Ç–æ–ª—å–∫–æ auth)
- `GET /rooms/:id` ‚Äî –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫–æ–º–Ω–∞—Ç–µ
- `POST /rooms/:id/join` ‚Äî –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ
- `GET /rooms` ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ó–∞—â–∏—Ç–∞ endpoints —á–µ—Ä–µ–∑ JWT

---

## üìö –ú–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∏–∑—É—á–µ–Ω–∏—è

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ
1. **[NestJS Guards](https://docs.nestjs.com/guards)**
   - –ó–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤
   - Custom guards

2. **[NestJS Custom Decorators](https://docs.nestjs.com/custom-decorators)**
   - @CurrentUser() –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ
- **[REST Best Practices](https://restfulapi.net/)**
- **[HTTP Status Codes](https://developer.mozilla.org/en-US/docs/Web/HTTP/Status)**

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –°–æ–∑–¥–∞—Ç—å DTO

**–í `apps/server/src/room/dto/create-room.dto.ts`:**
```typescript
import { IsString, IsOptional, MaxLength, MinLength } from 'class-validator';

export class CreateRoomDto {
  @IsOptional()
  @IsString()
  @MinLength(3, { message: '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞' })
  @MaxLength(50, { message: '–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–∫—Å–∏–º—É–º 50 —Å–∏–º–≤–æ–ª–æ–≤' })
  name?: string;
}
```

**–í `apps/server/src/room/dto/join-room.dto.ts`:**
```typescript
import { IsString, IsUUID } from 'class-validator';

export class JoinRoomDto {
  @IsString()
  roomId: string;
}
```

---

### –®–∞–≥ 2: CurrentUser –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä

**–í `apps/server/src/common/decorators/current-user.decorator.ts`:**
```typescript
import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export interface CurrentUserData {
  id: string;
  email: string;
  username: string;
}

export const CurrentUser = createParamDecorator(
  (data: unknown, ctx: ExecutionContext): CurrentUserData => {
    const request = ctx.switchToHttp().getRequest();
    return request.user;
  },
);
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
@Post()
createRoom(@CurrentUser() user: CurrentUserData, dto: CreateRoomDto) {
  // user.id, user.email, user.username –¥–æ—Å—Ç—É–ø–Ω—ã
}
```

---

### –®–∞–≥ 3: RoomController

**–í `apps/server/src/room/room.controller.ts`:**
```typescript
import {
  Controller,
  Get,
  Post,
  Body,
  Param,
  HttpCode,
  HttpStatus,
  UseGuards,
} from '@nestjs/common';
import { RoomService } from './room.service';
import { JwtAuthGuard } from '../auth/guards/jwt-auth.guard';
import { CurrentUser, CurrentUserData } from '../common/decorators/current-user.decorator';
import { CreateRoomDto } from './dto/create-room.dto';

@Controller('rooms')
@UseGuards(JwtAuthGuard)  // –í—Å–µ endpoints —Ç—Ä–µ–±—É—é—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é
export class RoomController {
  constructor(private roomService: RoomService) {}

  @Post()
  @HttpCode(HttpStatus.CREATED)
  async createRoom(
    @CurrentUser() user: CurrentUserData,
    @Body() dto: CreateRoomDto,
  ) {
    return this.roomService.createRoom(user.id, dto.name);
  }

  @Get()
  async getMyRooms(@CurrentUser() user: CurrentUserData) {
    return this.roomService.getUserRooms(user.id);
  }

  @Get(':id')
  async getRoom(@Param('id') id: string) {
    return this.roomService.getRoom(id);
  }

  @Post(':id/join')
  @HttpCode(HttpStatus.OK)
  async joinRoom(
    @Param('id') roomId: string,
    @CurrentUser() user: CurrentUserData,
  ) {
    return this.roomService.joinRoom(roomId, user.id);
  }

  @Post(':id/leave')
  @HttpCode(HttpStatus.OK)
  async leaveRoom(
    @Param('id') roomId: string,
    @CurrentUser() user: CurrentUserData,
  ) {
    return this.roomService.leaveRoom(roomId, user.id);
  }
}
```

---

### –®–∞–≥ 4: –û–±–Ω–æ–≤–∏—Ç—å RoomService

**–í `apps/server/src/room/room.service.ts`:**
```typescript
import { Injectable, NotFoundException, BadRequestException } from '@nestjs/common';
import { PrismaService } from '../prisma/prisma.service';
import { Room, User } from '@prisma/client';

type RoomWithHostAndParticipants = Room & {
  host: User;
  participants: User[];
};

@Injectable()
export class RoomService {
  constructor(private prisma: PrismaService) {}

  async createRoom(hostId: string, name?: string): Promise<RoomWithHostAndParticipants> {
    // –ü—Ä–æ–≤–µ—Ä–∏–º —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const user = await this.prisma.user.findUnique({
      where: { id: hostId },
    });

    if (!user) {
      throw new NotFoundException('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
    }

    return this.prisma.room.create({
      data: {
        name,
        hostId,
      },
      include: {
        host: true,
        participants: true,
      },
    });
  }

  async getRoom(id: string): Promise<RoomWithHostAndParticipants> {
    const room = await this.prisma.room.findUnique({
      where: { id },
      include: {
        host: true,
        participants: true,
      },
    });

    if (!room) {
      throw new NotFoundException('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    return room;
  }

  async joinRoom(roomId: string, userId: string): Promise<RoomWithHostAndParticipants> {
    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–æ–º–Ω–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    const room = await this.prisma.room.findUnique({
      where: { id: roomId },
      include: { participants: true },
    });

    if (!room) {
      throw new NotFoundException('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –Ω–µ –≤ –∫–æ–º–Ω–∞—Ç–µ
    const isAlreadyParticipant = room.participants.some(p => p.id === userId);

    if (isAlreadyParticipant) {
      throw new BadRequestException('–í—ã —É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç—ã');
    }

    // –î–æ–±–∞–≤–∏—Ç—å –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏
    return this.prisma.room.update({
      where: { id: roomId },
      data: {
        participants: {
          connect: { id: userId },
        },
      },
      include: {
        host: true,
        participants: true,
      },
    });
  }

  async leaveRoom(roomId: string, userId: string): Promise<void> {
    const room = await this.prisma.room.findUnique({
      where: { id: roomId },
      include: { participants: true },
    });

    if (!room) {
      throw new NotFoundException('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
    }

    const isParticipant = room.participants.some(p => p.id === userId);

    if (!isParticipant) {
      throw new BadRequestException('–í—ã –Ω–µ —É—á–∞—Å—Ç–Ω–∏–∫ —ç—Ç–æ–π –∫–æ–º–Ω–∞—Ç—ã');
    }

    await this.prisma.room.update({
      where: { id: roomId },
      data: {
        participants: {
          disconnect: { id: userId },
        },
      },
    });
  }

  async getUserRooms(userId: string): Promise<RoomWithHostAndParticipants[]> {
    return this.prisma.room.findMany({
      where: {
        OR: [
          { hostId: userId },
          { participants: { some: { id: userId } } },
        ],
      },
      include: {
        host: true,
        participants: true,
      },
      orderBy: {
        createdAt: 'desc',
      },
    });
  }
}
```

---

### –®–∞–≥ 5: RoomModule

**–í `apps/server/src/room/room.module.ts`:**
```typescript
import { Module } from '@nestjs/common';
import { RoomController } from './room.controller';
import { RoomService } from './room.service';
import { PrismaModule } from '../prisma/prisma.module';

@Module({
  imports: [PrismaModule],
  controllers: [RoomController],
  providers: [RoomService],
  exports: [RoomService],
})
export class RoomModule {}
```

---

## üéØ REST API Design

### HTTP Methods

| Method | –°–µ–º–∞–Ω—Ç–∏–∫–∞ | –ü—Ä–∏–º–µ—Ä |
|--------|-----------|--------|
| GET | –ü–æ–ª—É—á–∏—Ç—å —Ä–µ—Å—É—Ä—Å | `GET /rooms/:id` |
| POST | –°–æ–∑–¥–∞—Ç—å —Ä–µ—Å—É—Ä—Å | `POST /rooms` |
| PUT/PATCH | –û–±–Ω–æ–≤–∏—Ç—å —Ä–µ—Å—É—Ä—Å | `PATCH /rooms/:id` |
| DELETE | –£–¥–∞–ª–∏—Ç—å —Ä–µ—Å—É—Ä—Å | `DELETE /rooms/:id` |

---

### URL Design

**–•–æ—Ä–æ—à–æ:**
```
GET    /rooms           ‚Äî —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç
POST   /rooms           ‚Äî —Å–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
GET    /rooms/:id       ‚Äî –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è –∫–æ–º–Ω–∞—Ç–∞
POST   /rooms/:id/join  ‚Äî –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞–¥ —Ä–µ—Å—É—Ä—Å–æ–º
```

**–ü–ª–æ—Ö–æ:**
```
GET    /getRooms
POST   /createRoom
GET    /roomById?id=123
POST   /joinRoom
```

**–ü–æ—á–µ–º—É:**
- ‚úì –ì–ª–∞–≥–æ–ª—ã (join) –∫–∞–∫ —á–∞—Å—Ç—å –ø—É—Ç–∏ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π
- ‚úó –ì–ª–∞–≥–æ–ª—ã –≤ URL –¥–ª—è CRUD –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úì –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–π
- ‚úó –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–π

---

### Status Codes

| –ö–æ–¥ | Meaning | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|-----|---------|-------------------|
| 200 OK | –£—Å–ø–µ—Ö | GET, PATCH —É—Å–ø–µ—à–µ–Ω |
| 201 Created | –°–æ–∑–¥–∞–Ω | POST —Å–æ–∑–¥–∞–ª —Ä–µ—Å—É—Ä—Å |
| 204 No Content | –ù–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ | DELETE —É—Å–ø–µ—à–µ–Ω |
| 400 Bad Request | –û—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞ | –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ—à–ª–∞ |
| 401 Unauthorized | –ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω | –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ |
| 403 Forbidden | –ù–µ—Ç –ø—Ä–∞–≤ | –¢–æ–∫–µ–Ω –µ—Å—Ç—å, –Ω–æ –Ω–µ—Ç –ø—Ä–∞–≤ |
| 404 Not Found | –ù–µ –Ω–∞–π–¥–µ–Ω | –†–µ—Å—É—Ä—Å –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç |
| 409 Conflict | –ö–æ–Ω—Ñ–ª–∏–∫—Ç | –î—É–±–ª–∏–∫–∞—Ç, –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å |
| 500 Internal Error | –û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ | –ë–∞–≥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ |

---

## üîê –ó–∞—â–∏—Ç–∞ endpoints

### –£—Ä–æ–≤–µ–Ω—å –º–æ–¥—É–ª—è

**–í—Å–µ endpoints –∑–∞—â–∏—â–µ–Ω—ã:**
```typescript
@Controller('rooms')
@UseGuards(JwtAuthGuard)  // –ü—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫–æ –≤—Å–µ–º
export class RoomController {
  @Get()  // –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω
  getAll() {}

  @Post()  // –¢—Ä–µ–±—É–µ—Ç—Å—è —Ç–æ–∫–µ–Ω
  create() {}
}
```

---

### –£—Ä–æ–≤–µ–Ω—å –º–µ—Ç–æ–¥–∞

**–û—Ç–¥–µ–ª—å–Ω—ã–µ endpoints –∑–∞—â–∏—â–µ–Ω—ã:**
```typescript
@Controller('rooms')
export class RoomController {
  @Get('public')
  getPublic() {}  // –î–æ—Å—Ç—É–ø–µ–Ω –±–µ–∑ —Ç–æ–∫–µ–Ω–∞

  @Get('private')
  @UseGuards(JwtAuthGuard)  // –¢–æ–ª—å–∫–æ —ç—Ç–æ—Ç –º–µ—Ç–æ–¥
  getPrivate() {}
}
```

---

### –ü—É–±–ª–∏—á–Ω—ã–µ endpoints

**–ò—Å–ø–æ–ª—å–∑—É–π SkipAuthGuard:**
```typescript
@Controller('auth')
export class AuthController {
  @Post('login')
  @UseGuards(SkipAuthGuard)  // –ü—É–±–ª–∏—á–Ω—ã–π endpoint
  login() {}

  @Get('profile')
  @UseGuards(JwtAuthGuard)  // –ó–∞—â–∏—â—ë–Ω–Ω—ã–π
  getProfile() {}
}
```

---

## ‚ö†Ô∏è –ù—é–∞–Ω—Å—ã –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏

### 1. UUID –≤–∞–ª–∏–¥–∞—Ü–∏—è

**–ü–ª–æ—Ö–æ:**
```typescript
@Get(':id')
getRoom(@Param('id') id: string) {
  // id –º–æ–∂–µ—Ç –±—ã—Ç—å –ª—é–±—ã–º!
}
```

**–•–æ—Ä–æ—à–æ:**
```typescript
import { IsUUID } from 'class-validator';

export class RoomIdDto {
  @IsUUID('4')  // Prisma cuid –Ω–µ UUID, –Ω–æ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å custom validator
  id: string;
}

// –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å pipe
@Get(':id')
getRoom(@Param('id', new ParseIntPipe()) id: string) {
  // Prisma –≤—ã–±—Ä–æ—Å–∏—Ç –æ—à–∏–±–∫—É –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥—ë—Ç
}
```

---

### 2. –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞

**–ü—Ä–æ–≤–µ—Ä—å –ø–µ—Ä–µ–¥ join:**
```typescript
const isAlreadyParticipant = room.participants.some(
  p => p.id === userId
);

if (isAlreadyParticipant) {
  throw new BadRequestException('–í—ã —É–∂–µ —É—á–∞—Å—Ç–Ω–∏–∫');
}
```

**–ò–ª–∏ rely –Ω–∞ –ë–î (unique constraint):**
```prisma
// –î–ª—è —è–≤–Ω–æ–π —Ç–∞–±–ª–∏—Ü—ã —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ (–≤–º–µ—Å—Ç–æ –Ω–µ—è–≤–Ω–æ–π)
model RoomParticipant {
  roomId String
  userId String

  @@unique([roomId, userId])  // –ö–æ–º–±–∏–Ω–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–∞
}
```

---

### 3. cascade delete

**–ï—Å–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:**
```prisma
host User @relation(..., onDelete: Cascade)
```

**–í—Å–µ –∫–æ–º–Ω–∞—Ç—ã –≥–¥–µ –æ–Ω —Ö–æ—Å—Ç —É–¥–∞–ª—è—Ç—Å—è.**

**–í–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –Ω–µ –Ω—É–∂–Ω–æ:**
```prisma
host User @relation(..., onDelete: Restrict)  // –ò–ª–∏ SetNull (—Å nullable)
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [ ] `POST /rooms` —Å–æ–∑–¥–∞—ë—Ç –∫–æ–º–Ω–∞—Ç—É —Å —Ç–µ–∫—É—â–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –∫–∞–∫ —Ö–æ—Å—Ç–æ–º
- [ ] `GET /rooms` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–º–Ω–∞—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (—Ö–æ—Å—Ç + —É—á–∞—Å—Ç–Ω–∏–∫)
- [ ] `GET /rooms/:id` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–º–Ω–∞—Ç—É —Å —Ö–æ—Å—Ç–æ–º –∏ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏
- [ ] `POST /rooms/:id/join` –¥–æ–±–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —É—á–∞—Å—Ç–Ω–∏–∫–∏
- [ ] `POST /rooms/:id/leave` —É–¥–∞–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
- [ ] –í—Å–µ endpoints —Ç—Ä–µ–±—É—é—Ç JWT —Ç–æ–∫–µ–Ω
- [ ] –ù–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∫–æ–º–Ω–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 404

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### 1. –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É

```bash
# –°–Ω–∞—á–∞–ª–∞ –≤–æ–π—Ç–∏
curl -X POST http://localhost:3000/auth/login \
  -H "Content-Type: application/json" \
  -c cookies.txt \
  -d '{"email":"test@test.com","password":"123456"}'

# –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É
curl -X POST http://localhost:3000/rooms \
  -H "Content-Type: application/json" \
  -b cookies.txt \
  -d '{"name":"My Meeting"}'
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "id": "clx...",
  "name": "My Meeting",
  "hostId": "cly...",
  "host": { "id": "...", "email": "test@test.com", "username": "test" },
  "participants": [],
  "isActive": true,
  "createdAt": "2024-01-24T10:00:00.000Z"
}
```

---

### 2. –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ

```bash
curl -X POST http://localhost:3000/rooms/clx.../join \
  -b cookies.txt
```

---

### 3. –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–æ–º–Ω–∞—Ç

```bash
curl http://localhost:3000/rooms \
  -b cookies.txt
```

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–§–∞–∑–∞ 2: Signalling Server](../phase-02-signalling/README.md)**

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### 1. –ü–∞–≥–∏–Ω–∞—Ü–∏—è

```typescript
@Get()
async getMyRooms(
  @CurrentUser() user: CurrentUserData,
  @Query('page') page: number = 1,
  @Query('limit') limit: number = 10,
) {
  const skip = (page - 1) * limit;

  const [rooms, total] = await Promise.all([
    this.prisma.room.findMany({
      where: { hostId: user.id },
      skip,
      take: limit,
    }),
    this.prisma.room.count({ where: { hostId: user.id } }),
  ]);

  return {
    data: rooms,
    meta: {
      total,
      page,
      limit,
      totalPages: Math.ceil(total / limit),
    },
  };
}
```

---

### 2. –ü–æ–∏—Å–∫ –∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è

```typescript
@Get()
async searchRooms(
  @Query('q') search?: string,
  @Query('active') active?: 'true' | 'false',
) {
  return this.prisma.room.findMany({
    where: {
      AND: [
        search ? { name: { contains: search, mode: 'insensitive' } } : {},
        active !== undefined ? { isActive: active === 'true' } : {},
      ],
    },
  });
}
```

---

### 3. WebSocket —Å–æ–±—ã—Ç–∏—è

**–£–≤–µ–¥–æ–º–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –æ –Ω–æ–≤–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–µ:**
```typescript
async joinRoom(roomId: string, userId: string) {
  const room = await this.prisma.room.update({
    where: { id: roomId },
    data: {
      participants: { connect: { id: userId } },
    },
    include: { participants: true },
  });

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ WebSocket
  this.gateway.server.to(roomId).emit('user_joined', {
    userId,
    username: room.participants.find(p => p.id === userId)?.username,
  });

  return room;
}
```
