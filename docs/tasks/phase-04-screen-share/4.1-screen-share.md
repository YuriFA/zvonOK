# –ó–∞–¥–∞—á–∞ 4.1: –ü–æ–ª—É—á–∏—Ç—å –ø–æ—Ç–æ–∫ —ç–∫—Ä–∞–Ω–∞

## –û–±–∑–æ—Ä

–®–µ—Ä–∏–Ω–≥ —ç–∫—Ä–∞–Ω–∞ —á–µ—Ä–µ–∑ `getDisplayMedia`. –ó–∞–º–µ–Ω–∞ –≤–∏–¥–µ–æ —Ç—Ä–µ–∫–∞ –≤ peer connection.

## üéØ –¶–µ–ª—å

- `getDisplayMedia()` –ø–æ–ª—É—á–∞–µ—Ç –ø–æ—Ç–æ–∫ —ç–∫—Ä–∞–Ω–∞
- –í–∏–¥–µ–æ —Ç—Ä–µ–∫ –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω
- –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ —à–µ—Ä–∏–Ω–≥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–º–µ—Ä–∞
- –ö–Ω–æ–ø–∫–∞ —Å –∏–∫–æ–Ω–∫–æ–π "Share screen"

## üìö –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ

[getDisplayMedia MDN](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getDisplayMedia)

## üìù –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

```typescript
// apps/client/src/hooks/use-screen-share.ts
export function useScreenShare(
  localStream: MediaStream | null,
  peerConnection: RTCPeerConnection | null
) {
  const [isSharing, setIsSharing] = useState(false);
  const [screenStream, setScreenStream] = useState<MediaStream | null>(null);

  const startScreenShare = async () => {
    try {
      const stream = await navigator.mediaDevices.getDisplayMedia({
        video: {
          cursor: 'always',
        },
        audio: false,  // –û–±—ã—á–Ω–æ –Ω–µ –Ω—É–∂–µ–Ω
      });

      setScreenStream(stream);
      setIsSharing(true);

      // –ó–∞–º–µ–Ω–∏—Ç—å –≤–∏–¥–µ–æ —Ç—Ä–µ–∫ –≤ peer connection
      const videoTrack = stream.getVideoTracks()[0];
      const sender = peerConnection?.getSenders().find(
        s => s.track?.kind === 'video'
      );

      await sender?.replaceTrack(videoTrack);

      // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
      videoTrack.onended = () => {
        stopScreenShare();
      };

    } catch (err) {
      console.error('Error sharing screen:', err);
    }
  };

  const stopScreenShare = () => {
    if (!localStream || !peerConnection) return;

    // –í–µ—Ä–Ω—É—Ç—å –∫–∞–º–µ—Ä—É
    const videoTrack = localStream.getVideoTracks()[0];
    const sender = peerConnection.getSenders().find(
      s => s.track?.kind === 'video'
    );

    sender?.replaceTrack(videoTrack);

    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å screen stream
    screenStream?.getTracks().forEach(track => track.stop());

    setScreenStream(null);
    setIsSharing(false);
  };

  const toggleScreenShare = () => {
    if (isSharing) {
      stopScreenShare();
    } else {
      startScreenShare();
    }
  };

  return {
    isSharing,
    toggleScreenShare,
  };
}
```

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. Audio –≤ screen share

```typescript
const stream = await navigator.mediaDevices.getDisplayMedia({
  video: true,
  audio: true,  // –î–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∑–≤—É–∫–∞ (—Ç–æ–ª—å–∫–æ Chrome/Edge)
});
```

**–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:**
- –¢–æ–ª—å–∫–æ Chrome/Edge –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç audio
- –ù—É–∂–µ–Ω —Ñ–ª–∞–≥ `#enable-webrtc-hide-local-ips-with-mdns`
- –†–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞Êüê‰∫õ OS

### 2. Frame rate –¥–ª—è screen share

```typescript
const stream = await navigator.mediaDevices.getDisplayMedia({
  video: {
    frameRate: 30,  // –û–±—ã—á–Ω–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ
  },
});
```

### 3. –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ

```typescript
const stream = await navigator.mediaDevices.getDisplayMedia({
  video: {
    width: { ideal: 1920 },
    height: { ideal: 1080 },
  },
});
```

### 4. –í—ã–±–æ—Ä –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –æ–∫–Ω–∞/—ç–∫—Ä–∞–Ω–∞

–ë—Ä–∞—É–∑–µ—Ä —Å–∞–º –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞ ‚Äî –Ω–µ–ª—å–∑—è –ø—Ä–æ–≥—Ä–∞–º–Ω–æ –≤—ã–±—Ä–∞—Ç—å.

## üì∫ Screen Share + Audio (—Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–≤—É–∫)

### –í–∫–ª—é—á–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∑–≤—É–∫–∞

```typescript
const startScreenShare = async () => {
  try {
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: {
        cursor: 'always',
        frameRate: 30,
      },
      audio: {
        echoCancellation: true,
        noiseSuppression: true,
        sampleRate: 44100,
      },
    });

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ audio —Ç—Ä–µ–∫–∞
    const audioTrack = stream.getAudioTracks()[0];
    if (audioTrack) {
      // –ó–∞–º–µ–Ω–∏—Ç—å audio —Ç—Ä–µ–∫ (–¥–ª—è —Å–∏—Å—Ç–µ–º–Ω–æ–≥–æ –∑–≤—É–∫–∞)
      const audioSender = peerConnection?.getSenders().find(
        s => s.track?.kind === 'audio'
      );
      await audioSender?.replaceTrack(audioTrack);
    }

    // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥
  } catch (err) {
    console.error('Error sharing screen:', err);
  }
};
```

**–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –±—Ä–∞—É–∑–µ—Ä–æ–≤:**
| –ë—Ä–∞—É–∑–µ—Ä | Video | Audio (—Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–≤—É–∫) |
|---------|-------|------------------------|
| Chrome/Edge | ‚úÖ | ‚úÖ (—Å —Ñ–ª–∞–≥–æ–º) |
| Firefox | ‚úÖ | ‚ùå |
| Safari | ‚úÖ | ‚ùå |

**–í–∫–ª—é—á–µ–Ω–∏–µ –≤ Chrome:** `chrome://flags/#enable-webrtc-hide-local-ips-with-mdns`

### –ö–æ–º–±–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–≤—É–∫ (–º–∏–∫—Ä–æ—Ñ–æ–Ω + —Å–∏—Å—Ç–µ–º–Ω—ã–π)

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å –∏ –º–∏–∫—Ä–æ—Ñ–æ–Ω, –∏ —Å–∏—Å—Ç–µ–º–Ω—ã–π –∑–≤—É–∫ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:

```typescript
const mixAudioStreams = (micStream: MediaStream, screenStream: MediaStream) => {
  const audioContext = new AudioContext();
  const destination = audioContext.createMediaStreamDestination();

  // –ú–∏–∫—Ä–æ—Ñ–æ–Ω
  const micSource = audioContext.createMediaStreamSource(micStream);
  const micGain = audioContext.createGain();
  micGain.gain.value = 0.7; // –£–º–µ–Ω—å—à–∏—Ç—å –≥—Ä–æ–º–∫–æ—Å—Ç—å –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞
  micSource.connect(micGain).connect(destination);

  // –°–∏—Å—Ç–µ–º–Ω—ã–π –∑–≤—É–∫
  const screenAudioTrack = screenStream.getAudioTracks()[0];
  if (screenAudioTrack) {
    const screenSource = audioContext.createMediaStreamSource(
      new MediaStream([screenAudioTrack])
    );
    screenSource.connect(destination);
  }

  return destination.stream;
};
```

---

## üé• Screen Share –≤ –≥—Ä—É–ø–ø–æ–≤—ã—Ö –∑–≤–æ–Ω–∫–∞—Ö (SFU)

### –û—Ç–ª–∏—á–∏—è –æ—Ç P2P

–í SFU –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ (mediasoup) screen share —Ç—Ä–µ–±—É–µ—Ç —Å–æ–∑–¥–∞–Ω–∏—è **–æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ Producer**.

```typescript
// apps/client/src/hooks/use-screen-share-sfu.ts
export function useScreenShareSFU(
  device: mediasoup.Device,
  sendTransport: mediasoup.types.Transport
) {
  const [screenProducer, setScreenProducer] = useState<mediasoup.types.Producer | null>(null);

  const startScreenShare = async () => {
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: { cursor: 'always', frameRate: 30 },
      audio: true,
    });

    const videoTrack = stream.getVideoTracks()[0];
    const audioTrack = stream.getAudioTracks()[0];

    // –°–æ–∑–¥–∞—Ç—å producer –¥–ª—è screen video
    const videoProducer = await sendTransport.produce({
      track: videoTrack,
      codecOptions: {
        videoGoogleStartBitrate: 1000, // –ë–æ–ª—å—à–µ –±–∏—Ç—Ä–µ–π—Ç –¥–ª—è —ç–∫—Ä–∞–Ω–∞
      },
      appData: { source: 'screen' }, // –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ screen
    });

    // –°–æ–∑–¥–∞—Ç—å producer –¥–ª—è screen audio (–µ—Å–ª–∏ –µ—Å—Ç—å)
    let audioProducer;
    if (audioTrack) {
      audioProducer = await sendTransport.produce({
        track: audioTrack,
        appData: { source: 'screen-audio' },
      });
    }

    setScreenProducer(videoProducer);

    // –û–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É
    videoTrack.onended = () => {
      stopScreenShare();
    };

    // –£–≤–µ–¥–æ–º–∏—Ç—å —Å–µ—Ä–≤–µ—Ä –æ –Ω–∞—á–∞–ª–µ screen share
    socket.emit('start_screen_share', {
      producerId: videoProducer.id,
    });
  };

  const stopScreenShare = async () => {
    if (screenProducer) {
      screenProducer.close();
      setScreenProducer(null);

      // –£–≤–µ–¥–æ–º–∏—Ç—å —Å–µ—Ä–≤–µ—Ä
      socket.emit('stop_screen_share', {
        producerId: screenProducer.id,
      });
    }
  };

  return { startScreenShare, stopScreenShare };
}
```

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (mediasoup)

```typescript
// apps/server/src/webrtc/webrtc.gateway.ts
@SubscribeMessage('start_screen_share')
handleStartScreenShare(client: Socket, { producerId }: { producerId: string }) {
  // –£–≤–µ–¥–æ–º–∏—Ç—å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  client.to(client.data.roomId).emit('user_started_screen_share', {
    userId: client.data.userId,
    producerId,
  });
}

@SubscribeMessage('stop_screen_share')
handleStopScreenShare(client: Socket, { producerId }: { producerId: string }) {
  client.to(client.data.roomId).emit('user_stopped_screen_share', {
    userId: client.data.userId,
    producerId,
  });
}
```

### –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

```typescript
// –°–ª—É—à–∞—Ç—å —Å–æ–±—ã—Ç–∏—è screen share
socket.on('user_started_screen_share', async ({ userId, producerId }) => {
  // –°–æ–∑–¥–∞—Ç—å consumer –¥–ª—è screen
  const consumer = await recvTransport.consume({
    id: producerId,
    producerId,
    kind: 'video',
    rtpParameters,
  });

  // –î–æ–±–∞–≤–∏—Ç—å –≤ UI —Å –∏–Ω–¥–∏–∫–∞—Ü–∏–µ–π "screen"
  addScreenVideo(userId, consumer.track);
});
```

---

## üé® UI –∏–Ω–¥–∏–∫–∞—Ü–∏—è screen share

### –ü–æ–∫–∞–∑–∞—Ç—å "–∫—Ç–æ —à–∞—Ä–∏—Ç —ç–∫—Ä–∞–Ω"

```typescript
// apps/client/src/components/video-tile.tsx
interface VideoTileProps {
  stream: MediaStream;
  userName: string;
  isScreenShare?: boolean;
}

export function VideoTile({ stream, userName, isScreenShare }: VideoTileProps) {
  return (
    <div className="relative">
      <video ref={videoRef} autoPlay playsInline />
      
      {isScreenShare && (
        <div className="absolute top-2 left-2 bg-blue-600 px-2 py-1 rounded text-white text-xs">
          üñ•Ô∏è Screen Share
        </div>
      )}
      
      <div className="absolute bottom-2 left-2 bg-black/50 px-2 py-1 rounded text-white text-sm">
        {userName}
      </div>
    </div>
  );
}
```

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è

–í grid —Ä–∞—Å–∫–ª–∞–¥–∫–µ —ç–∫—Ä–∞–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å **–±–æ–ª—å—à–µ**:

```css
/* apps/client/src/components/video-grid.css */
.video-grid {
  display: grid;
  gap: 8px;
}

/* –û–±—ã—á–Ω—ã–µ –≤–∏–¥–µ–æ */
.video-tile {
  grid-column: span 1;
}

/* Screen share –∑–∞–Ω–∏–º–∞–µ—Ç –±–æ–ª—å—à–µ –º–µ—Å—Ç–∞ */
.video-tile.screen-share {
  grid-column: span 2;
  grid-row: span 2;
}
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ layout

```typescript
// apps/client/src/hooks/use-layout.ts
export function useLayout(participants: Participant[], screenShareActive: boolean) {
  if (screenShareActive) {
    // –≠–∫—Ä–∞–Ω –∫—Ä—É–ø–Ω–æ, –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–±–æ–∫—É
    return 'sidebar-layout';
  } else if (participants.length <= 4) {
    return 'grid-layout';
  } else {
    return 'gallery-layout';
  }
}
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. –ë–∏—Ç—Ä–µ–π—Ç –¥–ª—è screen share

–≠–∫—Ä–∞–Ω —Ç—Ä–µ–±—É–µ—Ç **–±–æ–ª—å—à–µ –±–∏—Ç—Ä–µ–π—Ç–∞** —á–µ–º –∫–∞–º–µ—Ä–∞:

```typescript
const videoProducer = await sendTransport.produce({
  track: videoTrack,
  encodings: [
    {
      maxBitrate: 3000000, // 3 Mbps –¥–ª—è —ç–∫—Ä–∞–Ω–∞
      scaleResolutionDownBy: 1, // –ù–µ —É–º–µ–Ω—å—à–∞—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
    },
  ],
});
```

### 2. Frame rate –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

–î–ª—è —Å—Ç–∞—Ç–∏—á–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Å–ª–∞–π–¥—ã) –º–æ–∂–Ω–æ —Å–Ω–∏–∑–∏—Ç—å FPS:

```typescript
const stream = await navigator.mediaDevices.getDisplayMedia({
  video: {
    frameRate: { ideal: 15, max: 30 }, // –ú–µ–Ω—å—à–µ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏
  },
});
```

### 3. –û–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞ + —ç–∫—Ä–∞–Ω

–ú–æ–∂–Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å **–∏ –∫–∞–º–µ—Ä—É, –∏ —ç–∫—Ä–∞–Ω** –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ:

```typescript
// –°–æ–∑–¥–∞—Ç—å 2 producers –≤ SFU
const cameraProducer = await sendTransport.produce({ track: cameraTrack });
const screenProducer = await sendTransport.produce({ track: screenTrack });

// –ù–∞ UI –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –æ–±–∞
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**P2P (1-–Ω–∞-1):**
- [ ] –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç `getDisplayMedia`
- [ ] –ë—Ä–∞—É–∑–µ—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥ –≤—ã–±–æ—Ä–∞
- [ ] –£–¥–∞–ª—ë–Ω–Ω—ã–π —É—á–∞—Å—Ç–Ω–∏–∫ –≤–∏–¥–∏—Ç —ç–∫—Ä–∞–Ω
- [ ] –ü—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–∞–º–µ—Ä–∞
- [ ] –†–∞–±–æ—Ç–∞–µ—Ç screen share + audio (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

**SFU (–≥—Ä—É–ø–ø–æ–≤—ã–µ):**
- [ ] –°–æ–∑–¥–∞—ë—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π Producer –¥–ª—è screen
- [ ] –í—Å–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ –≤–∏–¥—è—Ç —ç–∫—Ä–∞–Ω
- [ ] UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç "–∫—Ç–æ —à–∞—Ä–∏—Ç —ç–∫—Ä–∞–Ω"
- [ ] Screen share –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤ layout
- [ ] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç Producer

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è: [–§–∞–∑–∞ 5: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏](../phase-05-devices/5.1-2-3-devices.md)
