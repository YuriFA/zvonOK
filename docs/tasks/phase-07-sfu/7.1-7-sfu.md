# Ğ—Ğ°Ğ´Ğ°Ñ‡Ğ¸ 7.1-7.7: SFU Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ğ·Ğ²Ğ¾Ğ½ĞºĞ¾Ğ²

## ĞĞ±Ğ·Ğ¾Ñ€

Ğ˜Ğ½Ñ‚ĞµĞ³Ñ€Ğ°Ñ†Ğ¸Ñ mediasoup Ğ´Ğ»Ñ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ñ… Ğ²Ğ¸Ğ´ĞµĞ¾Ğ·Ğ²Ğ¾Ğ½ĞºĞ¾Ğ². SFU (Selective Forwarding Unit) Ğ¿ĞµÑ€ĞµÑÑ‹Ğ»Ğ°ĞµÑ‚ Ğ¼ĞµĞ´Ğ¸Ğ°-Ğ¿Ğ¾Ñ‚Ğ¾ĞºĞ¸ Ğ¼ĞµĞ¶Ğ´Ñƒ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°Ğ¼Ğ¸.

## ğŸ¯ Ğ¦ĞµĞ»ÑŒ

- Mediasoup worker Ğ¸ router ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ñ‹
- WebRtcTransport Ğ´Ğ»Ñ send/receive
- Producer Ğ´Ğ»Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¼ĞµĞ´Ğ¸Ğ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
- Consumer Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¼ĞµĞ´Ğ¸Ğ° Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
- ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ Ğ²Ğ¸Ğ´ÑÑ‚ Ğ´Ñ€ÑƒĞ³ Ğ´Ñ€ÑƒĞ³Ğ°

## ğŸ“š ĞĞ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾Ğµ

1. [mediasoup architecture](https://mediasoup.org/documentation/v3/architecture/)
2. [mediasoup server example](https://github.com/versatica/mediasoup-demo/blob/master/server.js)

## ğŸ“ ĞšĞ»ÑÑ‡ĞµĞ²Ñ‹Ğµ ĞºĞ¾Ğ½Ñ†ĞµĞ¿Ñ†Ğ¸Ğ¸

### ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° mediasoup

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SFU Server                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Worker â”‚  â”‚ Router â”‚  â”‚Transportâ”‚ â”‚Producerâ”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚  â”‚Consumerâ”‚  â”‚  Pipe  â”‚                           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â–²                    â–²                    â–²
        â”‚                    â”‚                    â”‚
    Client 1              Client 2             Client 3
```

### ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹

| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ |
|-----------|----------|
| **Worker** | ĞŸÑ€Ğ¾Ñ†ĞµÑÑ Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸, Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ°Ñ‚Ñ‹Ğ²Ğ°Ñ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ Router |
| **Router** | Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğ¹ endpoint Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ/Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ¸ Ğ¼ĞµĞ´Ğ¸Ğ° |
| **Transport** | Ğ¡Ğ¿Ğ¾ÑĞ¾Ğ± Ñ‚Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¸Ñ€Ğ¾Ğ²ĞºĞ¸ (WebRtcTransport Ğ´Ğ»Ñ ICE/DTLS) |
| **Producer** | ĞÑ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¼ĞµĞ´Ğ¸Ğ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€ (Ğ°ÑƒĞ´Ğ¸Ğ¾/Ğ²Ğ¸Ğ´ĞµĞ¾ Ñ‚Ñ€ĞµĞº) |
| **Consumer** | ĞŸĞ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¼ĞµĞ´Ğ¸Ğ° Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ° |
| **Pipe** | ĞŸĞµÑ€ĞµÑÑ‹Ğ»ĞºĞ° Ğ¼ĞµĞ¶Ğ´Ñƒ Router'Ğ°Ğ¼Ğ¸ (Ğ´Ğ»Ñ scalability) |

## ğŸ“ Ğ¨Ğ°Ğ³ 1: Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸ Ğ±Ğ°Ğ·Ğ¾Ğ²Ñ‹Ğ¹ ÑĞµÑ€Ğ²Ğ¸Ñ

```bash
pnpm add mediasoup
```

```typescript
// apps/server/src/webrtc/mediasoup.service.ts
import { Injectable, OnModuleInit } from '@nestjs/common';
import { mediasoup, Worker, Router, WebRtcTransport } from 'mediasoup';

@Injectable()
export class MediasoupService implements OnModuleInit {
  private workers: Worker[] = [];
  private routers = new Map<string, Router>();

  async onModuleInit() {
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ worker
    const worker = await mediasoup.createWorker({
      logLevel: 'warn',
      logTags: ['info', 'ice', 'dtls', 'rtp', 'srtp', 'rtcp'],
    });

    this.workers.push(worker);
  }

  async createRouter(roomId: string): Promise<Router> {
    if (this.routers.has(roomId)) {
      return this.routers.get(roomId)!;
    }

    const worker = this.workers[0];
    const router = await worker.createRouter({
      mediaCodecs: [
        {
          kind: 'audio',
          mimeType: 'audio/opus',
          clockRate: 48000,
          channels: 2,
        },
        {
          kind: 'video',
          mimeType: 'video/VP8',
          clockRate: 90000,
        },
        {
          kind: 'video',
          mimeType: 'video/H264',
          clockRate: 90000,
          parameters: {
            'packetization-mode': 1,
            'profile-level-id': '42e01f',
            'level-asymmetry-allowed': 1,
          },
        },
      ],
    });

    this.routers.set(roomId, router);
    return router;
  }

  getRouter(roomId: string): Router | undefined {
    return this.routers.get(roomId);
  }
}
```

## ğŸ“ Ğ¨Ğ°Ğ³ 2: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Transport

```typescript
// Ğ’ MediasoupService
async createWebRtcTransport(router: Router): Promise<{
  id: string;
  iceParameters: RTCIceParameters;
  iceCandidates: RTCIceCandidate[];
  dtlsParameters: RTCDtlsParameters;
}> {
  const transport = await router.createWebRtcTransport({
    listenIps: [{ ip: '0.0.0.0', announcedIp: undefined }],
    enableUdp: true,
    enableTcp: true,
    preferUdp: true,
  });

  return {
    id: transport.id,
    iceParameters: transport.iceParameters,
    iceCandidates: transport.iceCandidates,
    dtlsParameters: transport.dtlsParameters,
  };
}
```

## ğŸ“ Ğ¨Ğ°Ğ³ 3: Socket.io ÑĞ¾Ğ±Ñ‹Ñ‚Ğ¸Ñ Ğ´Ğ»Ñ Ñ‚Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚Ğ°

```typescript
// Ğ’ WebrtcGateway
private transports = new Map<string, WebRtcTransport>();

@SubscribeMessage('create_transport')
async handleCreateTransport(client: Socket, payload: {
  roomId: string;
  direction: 'send' | 'recv';
}) {
  const router = this.mediasoupService.getRouter(payload.roomId);

  if (!router) {
    throw new WsException('Router not found');
  }

  const transportInfo = await this.mediasoupService.createWebRtcTransport(router);

  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ transport
  this.transports.set(`${client.id}-${payload.direction}`, transportInfo);

  return transportInfo;
}

@SubscribeMessage('connect_transport')
async handleConnectTransport(client: Socket, payload: {
  transportId: string;
  dtlsParameters: RTCDtlsParameters;
}) {
  const transport = this.transports.get(payload.transportId);

  if (transport) {
    await transport.connect({ dtlsParameters: payload.dtlsParameters });
  }
}
```

## ğŸ“ Ğ¨Ğ°Ğ³ 4: Producer (Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ¼ĞµĞ´Ğ¸Ğ°)

```typescript
@SubscribeMessage('produce')
async handleProduce(client: Socket, payload: {
  transportId: string;
  kind: 'audio' | 'video';
  rtpParameters: any;
}) {
  const transport = this.transports.get(payload.transportId);

  if (!transport) {
    throw new WsException('Transport not found');
  }

  const producer = await transport.produce({
    kind: payload.kind,
    rtpParameters: payload.rtpParameters,
  });

  // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… Ğ¾ Ğ½Ğ¾Ğ²Ğ¾Ğ¼ Ğ¿Ñ€Ğ¾Ğ´ÑÑĞµÑ€Ğµ
  const roomId = /* Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¸Ğ· ĞºĞ¾Ğ½Ñ‚ĞµĞºÑÑ‚Ğ° */;
  this.server.to(roomId).emit('new_producer', {
    producerId: producer.id,
    kind: producer.kind,
    socketId: client.id,
  });

  return { id: producer.id };
}
```

## ğŸ“ Ğ¨Ğ°Ğ³ 5: ĞšĞ»Ğ¸ĞµĞ½Ñ‚ (mediasoup-client)

```bash
pnpm add mediasoup-client
```

```typescript
// apps/client/src/lib/mediasoup.ts
import { Device, types } from 'mediasoup-client';

export async function createDevice(routerRtpCapabilities: types.RtpCapabilities): Promise<Device> {
  const device = new Device();
  await device.load({ routerRtpCapabilities });
  return device;
}
```

```typescript
// Ğ’ ĞºĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ğµ Room
const device = useRef<Device | null>(null);
const sendTransport = useRef<Transport | null>(null);
const recvTransport = useRef<Transport | null>(null);

useEffect(() => {
  // ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ RTP capabilities
  socket.emit('get_router_rtp_capabilities', { roomId }, async (capabilities) => {
    device.current = await createDevice(capabilities);

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ send transport
    socket.emit('create_transport', { roomId, direction: 'send' }, async (transportInfo) => {
      sendTransport.current = device.current!.createSendTransport({
        id: transportInfo.id,
        iceParameters: transportInfo.iceParameters,
        iceCandidates: transportInfo.iceCandidates,
        dtlsParameters: transportInfo.dtlsParameters,
      });

      // connect handler
      sendTransport.current.on('connect', ({ dtlsParameters }, callback, errback) => {
        socket.emit('connect_transport', {
          transportId: transportInfo.id,
          dtlsParameters,
        });
        callback();
      });

      // produce handler
      sendTransport.current.on('produce', ({ kind, rtpParameters }, callback, errback) => {
        socket.emit('produce', {
          transportId: transportInfo.id,
          kind,
          rtpParameters,
        }, ({ id }) => callback({ id }));
      });

      // ĞŸÑ€Ğ¾Ğ´ÑÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ñ€ĞµĞºĞ¸
      localStream!.getTracks().forEach(track => {
        sendTransport.current!.produce({
          track,
          encodings: [{ maxBitrate: 1000000 }],
        });
      });
    });
  });
}, [roomId, localStream]);
```

## ğŸ“ Ğ¨Ğ°Ğ³ 6: Consumer (Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ğµ Ğ¼ĞµĞ´Ğ¸Ğ°)

```typescript
// Ğ¡ĞµÑ€Ğ²ĞµÑ€ - Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ñ‹ Ğ¿Ñ€Ğ¾Ğ´ÑÑĞµÑ€Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ½ÑÑŒÑĞ¼Ğ¸Ğ½Ğ³Ğ°
@SubscribeMessage('get_producer_rtp_parameters')
async handleGetProducerRtpParameters(client: Socket, payload: {
  roomId: string;
  producerId: string;
}) {
  const router = this.mediasoupService.getRouter(payload.roomId);

  if (!router) {
    throw new WsException('Router not found');
  }

  // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾Ğ´ÑÑĞµÑ€Ñ‹
  const producer = this.producers.get(payload.producerId);

  if (!producer) {
    throw new WsException('Producer not found');
  }

  return {
    rtpParameters: producer.rtpParameters,
    kind: producer.kind,
  };
}

// ĞšĞ»Ğ¸ĞµĞ½Ñ‚ - ĞºĞ¾Ğ½ÑÑŒÑĞ¼Ğ¸Ğ½Ğ³
socket.on('new_producer', async ({ producerId, kind }) => {
  const { rtpParameters } = await emitWithAck('get_producer_rtp_parameters', {
    roomId,
    producerId,
  });

  const consumer = await recvTransport.consume({
    producerId,
    rtpParameters,
    kind,
  });

  const newStream = new MediaStream();
  newStream.addTrack(consumer.track);

  setRemoteStreams(prev => [...prev, newStream]);
});
```

## âš ï¸ Ğ’Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ½ÑĞ°Ğ½ÑÑ‹

### 1. listenIps configuration

```typescript
// Local development
listenIps: [{ ip: '0.0.0.0', announcedIp: undefined }]

// Production (Ñ Ğ¿ÑƒĞ±Ğ»Ğ¸Ñ‡Ğ½Ñ‹Ğ¼ IP)
listenIps: [{ ip: '0.0.0.0', announcedIp: '203.0.113.5' }]

// Ğ˜Ğ»Ğ¸ Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ÑŒ IP Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹ÑĞ°
listenIps: [{ ip: '192.168.1.10', announcedIp: undefined }]
```

### 2. Simulcast

```typescript
// ĞšĞ»Ğ¸ĞµĞ½Ñ‚ - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²
sendTransport.produce({
  track,
  encodings: [
    { maxBitrate: 500000, scaleResolutionDownBy: 4 },
    { maxBitrate: 1000000, scaleResolutionDownBy: 2 },
    { maxBitrate: 2000000, scaleResolutionDownBy: 1 },
  ],
  codecOptions: {
    videoGoogleStartBitrate: 1000,
  },
});
```

### 3. CPU usage

mediasoup Ñ‚Ñ€ĞµĞ±ÑƒĞµÑ‚ Ğ·Ğ½Ğ°Ñ‡Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ñ… CPU Ñ€ĞµÑÑƒÑ€ÑĞ¾Ğ². Ğ”Ğ»Ñ Ğ¼Ğ½Ğ¾Ğ³Ğ¸Ñ… Ğ¿Ğ°Ñ€Ğ°Ğ»Ğ»ĞµĞ»ÑŒĞ½Ñ‹Ñ… Ğ·Ğ²Ğ¾Ğ½ĞºĞ¾Ğ² Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹Ñ‚Ğµ Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¾ worker'Ğ¾Ğ² Ğ¸ Ğ±Ğ°Ğ»Ğ°Ğ½ÑĞ¸Ñ€Ğ¾Ğ²ĞºÑƒ.

---

## ğŸ”„ ĞŸĞ¾Ğ»Ğ½Ñ‹Ğ¹ Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¼Ğ¸ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°Ğ¼Ğ¸

### Ğ¡ĞµÑ€Ğ²ĞµÑ€Ğ½Ğ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ: Tracking Ğ²ÑĞµÑ… Producer/Consumer

```typescript
// apps/server/src/webrtc/webrtc.service.ts
interface PeerInfo {
  socket: Socket;
  producers: Map<string, mediasoup.types.Producer>; // producerId -> Producer
  consumers: Map<string, mediasoup.types.Consumer>; // consumerId -> Consumer
  transport: {
    send?: mediasoup.types.WebRtcTransport;
    recv?: mediasoup.types.WebRtcTransport;
  };
}

@Injectable()
export class WebrtcService {
  private rooms = new Map<string, Map<string, PeerInfo>>(); // roomId -> (peerId -> PeerInfo)

  async handleUserJoin(roomId: string, peerId: string, socket: Socket) {
    if (!this.rooms.has(roomId)) {
      this.rooms.set(roomId, new Map());
    }

    const room = this.rooms.get(roomId)!;
    
    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ PeerInfo
    room.set(peerId, {
      socket,
      producers: new Map(),
      consumers: new Map(),
      transport: {},
    });

    // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ğ¾Ğ³Ğ¾ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ° Ğ¾ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… producer'Ğ°Ñ…
    const existingProducers: Array<{ peerId: string; producerId: string; kind: string }> = [];
    
    room.forEach((peer, existingPeerId) => {
      if (existingPeerId === peerId) return; // ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ ÑĞµĞ±Ñ
      
      peer.producers.forEach((producer, producerId) => {
        existingProducers.push({
          peerId: existingPeerId,
          producerId,
          kind: producer.kind,
        });
      });
    });

    return { existingProducers };
  }

  async handleNewProducer(
    roomId: string,
    peerId: string,
    producerId: string,
    producer: mediasoup.types.Producer
  ) {
    const room = this.rooms.get(roomId);
    if (!room) return;

    const peer = room.get(peerId);
    if (!peer) return;

    // Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ producer
    peer.producers.set(producerId, producer);

    // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ’Ğ¡Ğ•Ğ¥ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
    room.forEach((otherPeer, otherPeerId) => {
      if (otherPeerId === peerId) return; // ĞĞµ ÑƒĞ²ĞµĞ´Ğ¾Ğ¼Ğ»ÑÑ‚ÑŒ ÑĞµĞ±Ñ

      otherPeer.socket.emit('new_producer', {
        peerId,
        producerId,
        kind: producer.kind,
      });
    });
  }

  async handleUserLeave(roomId: string, peerId: string) {
    const room = this.rooms.get(roomId);
    if (!room) return;

    const peer = room.get(peerId);
    if (!peer) return;

    // Ğ—Ğ°ĞºÑ€Ñ‹Ñ‚ÑŒ Ğ²ÑĞµ Ñ‚Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚Ñ‹ Ğ¸ producer/consumer
    peer.transport.send?.close();
    peer.transport.recv?.close();
    peer.producers.forEach(p => p.close());
    peer.consumers.forEach(c => c.close());

    // Ğ£Ğ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ Ğ¸Ğ· ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹
    room.delete(peerId);

    // Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ¸Ñ‚ÑŒ Ğ¾ÑÑ‚Ğ°Ğ»ÑŒĞ½Ñ‹Ñ…
    room.forEach(otherPeer => {
      otherPeer.socket.emit('user_left', { peerId });
    });

    // Ğ•ÑĞ»Ğ¸ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ğ° Ğ¿ÑƒÑÑ‚Ğ°Ñ, ÑƒĞ´Ğ°Ğ»Ğ¸Ñ‚ÑŒ ĞµÑ‘
    if (room.size === 0) {
      this.rooms.delete(roomId);
    }
  }
}
```

### ĞšĞ»Ğ¸ĞµĞ½Ñ‚ÑĞºĞ°Ñ Ñ‡Ğ°ÑÑ‚ÑŒ: ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¾Ğµ consume Ğ²ÑĞµÑ… Producer'Ğ¾Ğ²

```typescript
// apps/client/src/hooks/use-sfu-room.ts
export function useSFURoom(roomId: string, localStream: MediaStream | null) {
  const [peers, setPeers] = useState<Map<string, MediaStream>>(new Map());
  const [device, setDevice] = useState<mediasoup.Device | null>(null);
  const sendTransport = useRef<mediasoup.types.Transport | null>(null);
  const recvTransport = useRef<mediasoup.types.Transport | null>(null);

  // Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€Ğ¸ join
  useEffect(() => {
    if (!localStream) return;

    socket.emit('join_room', { roomId }, async ({ existingProducers }) => {
      // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ device Ğ¸ transports...
      // (ĞºĞ¾Ğ´ Ğ¸Ğ· Ğ¿Ñ€ĞµĞ´Ñ‹Ğ´ÑƒÑ‰Ğ¸Ñ… ÑˆĞ°Ğ³Ğ¾Ğ²)

      // Consume Ğ²ÑĞµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ producer'Ñ‹
      for (const { peerId, producerId, kind } of existingProducers) {
        await consumeProducer(peerId, producerId, kind);
      }
    });

    // Ğ¡Ğ»ÑƒÑˆĞ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ñ… producer'Ğ¾Ğ²
    socket.on('new_producer', async ({ peerId, producerId, kind }) => {
      await consumeProducer(peerId, producerId, kind);
    });

    // Ğ¡Ğ»ÑƒÑˆĞ°Ñ‚ÑŒ Ğ¾Ñ‚ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ²
    socket.on('user_left', ({ peerId }) => {
      setPeers(prev => {
        const updated = new Map(prev);
        updated.delete(peerId);
        return updated;
      });
    });

    return () => {
      socket.off('new_producer');
      socket.off('user_left');
    };
  }, [roomId, localStream]);

  const consumeProducer = async (peerId: string, producerId: string, kind: string) => {
    // Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ RTP parameters
    const { rtpParameters } = await socket.emitWithAck('get_producer_rtp_parameters', {
      roomId,
      producerId,
    });

    // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ consumer
    const consumer = await recvTransport.current!.consume({
      id: producerId,
      producerId,
      kind,
      rtpParameters,
    });

    // Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ¸Ñ‚ÑŒ Ñ‚Ñ€ĞµĞº Ğ² stream ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ°
    setPeers(prev => {
      const updated = new Map(prev);
      let peerStream = updated.get(peerId);
      
      if (!peerStream) {
        peerStream = new MediaStream();
        updated.set(peerId, peerStream);
      }
      
      peerStream.addTrack(consumer.track);
      return updated;
    });

    // Resume consumer (Ğ²Ğ°Ğ¶Ğ½Ğ¾!)
    socket.emit('resume_consumer', { consumerId: consumer.id });
  };

  return { peers };
}
```

---

## ğŸ”Œ Reconnection Ğ»Ğ¾Ğ³Ğ¸ĞºĞ°

### ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° Ğ¾Ğ±Ñ€Ñ‹Ğ²Ğ° ÑĞ¾ĞµĞ´Ğ¸Ğ½ĞµĞ½Ğ¸Ñ

```typescript
// apps/client/src/hooks/use-reconnection.ts
export function useReconnection(
  roomId: string,
  sendTransport: mediasoup.types.Transport | null,
  recvTransport: mediasoup.types.Transport | null
) {
  useEffect(() => {
    if (!sendTransport || !recvTransport) return;

    // Ğ¡Ğ»ĞµĞ´Ğ¸Ñ‚ÑŒ Ğ·Ğ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸ĞµĞ¼ Ñ‚Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚Ğ¾Ğ²
    sendTransport.on('connectionstatechange', async (state) => {
      console.log('Send transport state:', state);

      if (state === 'failed') {
        console.warn('Send transport failed, reconnecting...');
        await reconnectTransport('send');
      }
    });

    recvTransport.on('connectionstatechange', async (state) => {
      console.log('Recv transport state:', state);

      if (state === 'failed') {
        console.warn('Recv transport failed, reconnecting...');
        await reconnectTransport('recv');
      }
    });
  }, [sendTransport, recvTransport]);

  const reconnectTransport = async (type: 'send' | 'recv') => {
    try {
      // Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ transport
      const { transportInfo } = await socket.emitWithAck('create_transport', {
        roomId,
        type,
      });

      // Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ transport...
      // (Ğ°Ğ½Ğ°Ğ»Ğ¾Ğ³Ğ¸Ñ‡Ğ½Ğ¾ Ğ½Ğ°Ñ‡Ğ°Ğ»ÑŒĞ½Ğ¾Ğ¹ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸)

      // Ğ•ÑĞ»Ğ¸ send transport â€” Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾ Ğ¿Ñ€Ğ¾Ğ´ÑÑĞ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ñ‚Ñ€ĞµĞºĞ¸
      if (type === 'send' && localStream) {
        localStream.getTracks().forEach(track => {
          sendTransport?.produce({ track });
        });
      }

      console.log(`${type} transport reconnected`);
    } catch (err) {
      console.error(`Failed to reconnect ${type} transport:`, err);
    }
  };
}
```

### Ğ¡ĞµÑ€Ğ²ĞµÑ€Ğ½Ğ°Ñ Ğ¾Ğ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° disconnection

```typescript
// apps/server/src/webrtc/webrtc.gateway.ts
@WebSocketGateway()
export class WebrtcGateway {
  handleDisconnect(client: Socket) {
    const roomId = client.data.roomId;
    const peerId = client.data.peerId;

    if (roomId && peerId) {
      // Cleanup Ñ Ğ·Ğ°Ğ´ĞµÑ€Ğ¶ĞºĞ¾Ğ¹ (Ğ¼Ğ¾Ğ¶ĞµÑ‚ reconnect'Ğ¸Ñ‚ÑŒÑÑ)
      setTimeout(() => {
        this.webrtcService.handleUserLeave(roomId, peerId);
      }, 5000); // 5 ÑĞµĞºÑƒĞ½Ğ´ Ğ½Ğ° reconnection
    }
  }
}
```

---

## ğŸš€ Simulcast Ğ¸ SVC Ğ´Ğ»Ñ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ bandwidth

### Simulcast â€” Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° Ğ½ĞµÑĞºĞ¾Ğ»ÑŒĞºĞ¸Ñ… ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²

```typescript
// ĞšĞ»Ğ¸ĞµĞ½Ñ‚ - Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ 3 ÑĞ»Ğ¾Ñ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°
const videoProducer = await sendTransport.produce({
  track: videoTrack,
  encodings: [
    { rid: 'r0', maxBitrate: 100000, scaleResolutionDownBy: 4 },  // Low
    { rid: 'r1', maxBitrate: 500000, scaleResolutionDownBy: 2 },  // Medium
    { rid: 'r2', maxBitrate: 1500000, scaleResolutionDownBy: 1 }, // High
  ],
  codecOptions: {
    videoGoogleStartBitrate: 1000,
  },
});

// Ğ¡ĞµÑ€Ğ²ĞµÑ€ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ñ‹Ğ±ĞµÑ€ĞµÑ‚ Ğ¿Ğ¾Ğ´Ñ…Ğ¾Ğ´ÑÑ‰Ğ¸Ğ¹ ÑĞ»Ğ¾Ğ¹ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ³Ğ¾ consumer'Ğ°
```

### Consumer Ğ²Ñ‹Ğ±Ğ¾Ñ€ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°

```typescript
// ĞšĞ»Ğ¸ĞµĞ½Ñ‚ Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¾Ğ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ½Ğ¾Ğµ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾
socket.emit('set_preferred_layers', {
  consumerId: consumer.id,
  spatialLayer: 2, // 0 = low, 1 = medium, 2 = high
  temporalLayer: 2,
});
```

### ĞĞ´Ğ°Ğ¿Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ´ bandwidth

```typescript
// ĞœĞ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³ bandwidth Ğ½Ğ° ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğµ
consumer.on('stats', (stats) => {
  const bytesReceived = stats.bytesReceived;
  const packetsLost = stats.packetsLost;
  
  if (packetsLost > 100) {
    // Ğ¡Ğ½Ğ¸Ğ·Ğ¸Ñ‚ÑŒ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ¾
    socket.emit('set_preferred_layers', {
      consumerId: consumer.id,
      spatialLayer: 0, // ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒÑÑ Ğ½Ğ° low quality
    });
  }
});
```

---

## âœ… ĞšÑ€Ğ¸Ñ‚ĞµÑ€Ğ¸Ğ¸ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ

**Ğ‘Ğ°Ğ·Ğ¾Ğ²Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾ÑÑ‚ÑŒ:**
- [ ] Mediasoup worker ÑĞ¾Ğ·Ğ´Ğ°Ğ½
- [ ] Router ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ğ´Ğ»Ñ ĞºĞ°Ğ¶Ğ´Ğ¾Ğ¹ ĞºĞ¾Ğ¼Ğ½Ğ°Ñ‚Ñ‹
- [ ] Transport ÑĞ¾Ğ·Ğ´Ğ°Ñ‘Ñ‚ÑÑ Ğ¸ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ
- [ ] Producer Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ÑĞµÑ‚ Ğ¼ĞµĞ´Ğ¸Ğ° Ğ½Ğ° ÑĞµÑ€Ğ²ĞµÑ€
- [ ] Consumer Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ°ĞµÑ‚ Ğ¼ĞµĞ´Ğ¸Ğ° Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
- [ ] 3+ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ğ²Ğ¸Ğ´ÑÑ‚ Ğ´Ñ€ÑƒĞ³ Ğ´Ñ€ÑƒĞ³Ğ°

**ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸:**
- [ ] ĞŸÑ€Ğ¸ join Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ consume Ğ²ÑĞµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ producer'Ñ‹
- [ ] ĞĞ¾Ğ²Ñ‹Ğµ producer'Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ consume'ÑÑ‚ÑÑ Ğ²ÑĞµĞ¼Ğ¸
- [ ] ĞŸÑ€Ğ¸ leave ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¸ ĞºĞ¾Ñ€Ñ€ĞµĞºÑ‚Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»ÑÑÑ‚ÑÑ
- [ ] Ğ’Ğ¸Ğ´ĞµĞ¾ Ğ²ÑĞµÑ… ÑƒÑ‡Ğ°ÑÑ‚Ğ½Ğ¸ĞºĞ¾Ğ² Ğ¾Ñ‚Ğ¾Ğ±Ñ€Ğ°Ğ¶Ğ°ÑÑ‚ÑÑ Ğ¾Ğ´Ğ½Ğ¾Ğ²Ñ€ĞµĞ¼ĞµĞ½Ğ½Ğ¾

**Reconnection:**
- [ ] ĞŸÑ€Ğ¸ Ğ¾Ğ±Ñ€Ñ‹Ğ²Ğµ Ñ‚Ñ€Ğ°Ğ½ÑĞ¿Ğ¾Ñ€Ñ‚ Ğ¿ĞµÑ€ĞµĞ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ğ°ĞµÑ‚ÑÑ
- [ ] Producer'Ñ‹ Ğ²Ğ¾ÑÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ÑÑ‚ÑÑ Ğ¿Ğ¾ÑĞ»Ğµ reconnect
- [ ] Consumer'Ñ‹ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ÑÑ‚ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°Ñ‚ÑŒ Ğ¿Ğ¾ÑĞ»Ğµ reconnect

**ĞĞ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ (Ğ¾Ğ¿Ñ†Ğ¸Ğ¾Ğ½Ğ°Ğ»ÑŒĞ½Ğ¾):**
- [ ] Simulcast Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ (3 ÑĞ»Ğ¾Ñ ĞºĞ°Ñ‡ĞµÑÑ‚Ğ²Ğ°)
- [ ] ĞĞ´Ğ°Ğ¿Ñ‚Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ¾Ğ´ bandwidth Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğ°ĞµÑ‚
- [ ] SVC Ğ¸Ğ»Ğ¸ SVC fallback

---

## ğŸ® Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ°Ñ: [Ğ¤Ğ°Ğ·Ğ° 8: Ğ’Ğ¸Ğ´ĞµĞ¾-Ğ³Ñ€Ğ¸Ğ´](../phase-08-video-grid/8.1-2-video-grid.md)
