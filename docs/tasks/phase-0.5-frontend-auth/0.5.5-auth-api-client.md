# –ó–∞–¥–∞—á–∞ 0.5.5: Auth API Client (—Å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–æ–≤)

> **–°—Ç–∞—Ç—É—Å:** ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
>
> **–§–∞–π–ª—ã:**
> - `apps/client/src/lib/api-client.ts`
> - `apps/client/src/lib/api.errors.ts`
> - `apps/client/src/features/auth/auth-api.ts`

## –û–±–∑–æ—Ä

–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ API –∫–ª–∏–µ–Ω—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º JWT —Ç–æ–∫–µ–Ω–æ–≤ —á–µ—Ä–µ–∑ refresh token rotation.

---

## üéØ –¶–µ–ª—å

- Fetch-based API –∫–ª–∏–µ–Ω—Ç —Å interceptors
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ access —Ç–æ–∫–µ–Ω–∞
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (401, 403, 404, 409, 500)
- Retry –ª–æ–≥–∏–∫–∞ –¥–ª—è refresh token
- HTTP-only cookies –¥–ª—è —Ç–æ–∫–µ–Ω–æ–≤

---

## üìù –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –ö–ª–∞—Å—Å—ã –æ—à–∏–±–æ–∫ API

**–í `apps/client/src/lib/api.errors.ts`:**

```typescript
export class ApiError extends Error {
  constructor(
    public statusCode: number,
    message: string,
    public data?: unknown
  ) {
    super(message);
    this.name = 'ApiError';
  }
}

export class UnauthorizedError extends ApiError {
  constructor(message = 'Unauthorized') {
    super(401, message);
    this.name = 'UnauthorizedError';
  }
}

export class ForbiddenError extends ApiError {
  constructor(message = 'Forbidden') {
    super(403, message);
    this.name = 'ForbiddenError';
  }
}

export class NotFoundError extends ApiError {
  constructor(message = 'Not found') {
    super(404, message);
    this.name = 'NotFoundError';
  }
}

export class ConflictError extends ApiError {
  constructor(message = 'Conflict') {
    super(409, message);
    this.name = 'ConflictError';
  }
}

export class ValidationError extends ApiError {
  constructor(message = 'Validation failed', public fields?: Record<string, string>) {
    super(422, message);
    this.name = 'ValidationError';
  }
}

export class NetworkError extends Error {
  constructor(message = 'Network error') {
    super(message);
    this.name = 'NetworkError';
  }
}
```

---

### –®–∞–≥ 2: API –∫–ª–∏–µ–Ω—Ç —Å interceptors

**–í `apps/client/src/lib/api-client.ts`:**

```typescript
import { ApiError, UnauthorizedError, NetworkError } from './api.errors';

const API_BASE_URL = import.meta.env.VITE_API_BASE_URL || 'http://localhost:3000';

let isRefreshing = false;
let refreshPromise: Promise<void> | null = null;

async function refreshToken(): Promise<void> {
  // –ï—Å–ª–∏ —É–∂–µ –∏–¥—ë—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ - –≤–µ—Ä–Ω—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ–º–∏—Å
  if (refreshPromise) {
    return refreshPromise;
  }

  refreshPromise = (async () => {
    try {
      const response = await fetch(`${API_BASE_URL}/auth/refresh`, {
        method: 'POST',
        credentials: 'include',
        headers: {
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new UnauthorizedError('Session expired');
      }
    } finally {
      isRefreshing = false;
      refreshPromise = null;
    }
  })();

  return refreshPromise;
}

export interface RequestConfig {
  method?: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
  body?: unknown;
  headers?: HeadersInit;
  credentials?: RequestCredentials;
}

export async function apiRequest<T>(
  endpoint: string,
  config: RequestConfig = {}
): Promise<T> {
  const {
    method = 'GET',
    body,
    headers = {},
    credentials = 'include',
  } = config;

  const url = `${API_BASE_URL}${endpoint}`;

  const requestInit: RequestInit = {
    method,
    credentials,
    headers: {
      'Content-Type': 'application/json',
      ...headers,
    },
  };

  if (body) {
    requestInit.body = JSON.stringify(body);
  }

  let response = await fetch(url, requestInit);

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ 401 - –ø–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
  if (response.status === 401 && !endpoint.includes('/auth/refresh')) {
    try {
      await refreshToken();

      // –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–ø—Ä–æ—Å —Å –Ω–æ–≤—ã–º —Ç–æ–∫–µ–Ω–æ–º
      response = await fetch(url, requestInit);
    } catch {
      // Refresh –Ω–µ —É–¥–∞–ª—Å—è - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ –ª–æ–≥–∏–Ω
      window.location.href = '/login';
      throw new UnauthorizedError('Session expired. Please log in again.');
    }
  }

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
  if (!response.ok) {
    await handleErrorResponse(response);
  }

  // –ü–∞—Ä—Å–∏–Ω–≥ JSON –æ—Ç–≤–µ—Ç–∞
  const contentType = response.headers.get('content-type');
  if (contentType && contentType.includes('application/json')) {
    return response.json();
  }

  return undefined as T;
}

async function handleErrorResponse(response: Response): Promise<never> {
  const status = response.status;
  const contentType = response.headers.get('content-type');

  let errorData: unknown;

  if (contentType && contentType.includes('application/json')) {
    errorData = await response.json().catch(() => ({}));
  }

  const message =
    typeof errorData === 'object' &&
    errorData !== null &&
    'message' in errorData &&
    typeof errorData.message === 'string'
      ? errorData.message
      : response.statusText || 'An error occurred';

  switch (status) {
    case 400:
      throw new ApiError(400, message, errorData);
    case 401:
      throw new UnauthorizedError(message);
    case 403:
      throw new ApiError(403, message, errorData);
    case 404:
      throw new ApiError(404, message, errorData);
    case 409:
      throw new ApiError(409, message, errorData);
    case 422:
      throw new ApiError(422, message, errorData);
    case 500:
      throw new ApiError(500, 'Server error. Please try again later.', errorData);
    default:
      throw new ApiError(status, message, errorData);
  }
}

// –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è HTTP –º–µ—Ç–æ–¥–æ–≤
export const api = {
  get: <T>(endpoint: string, config?: Omit<RequestConfig, 'method' | 'body'>) =>
    apiRequest<T>(endpoint, { ...config, method: 'GET' }),

  post: <T>(endpoint: string, body: unknown, config?: Omit<RequestConfig, 'method' | 'body'>) =>
    apiRequest<T>(endpoint, { ...config, method: 'POST', body }),

  put: <T>(endpoint: string, body: unknown, config?: Omit<RequestConfig, 'method' | 'body'>) =>
    apiRequest<T>(endpoint, { ...config, method: 'PUT', body }),

  patch: <T>(endpoint: string, body: unknown, config?: Omit<RequestConfig, 'method' | 'body'>) =>
    apiRequest<T>(endpoint, { ...config, method: 'PATCH', body }),

  delete: <T>(endpoint: string, config?: Omit<RequestConfig, 'method' | 'body'>) =>
    apiRequest<T>(endpoint, { ...config, method: 'DELETE' }),
};
```

---

### –®–∞–≥ 3: Auth API —Å–µ—Ä–≤–∏—Å

**–í `apps/client/src/features/auth/auth-api.ts`:**

```typescript
import { api } from '../../lib/api-client';

export interface LoginRequest {
  email: string;
  password: string;
}

export interface RegisterRequest {
  username: string;
  email: string;
  password: string;
}

export interface AuthResponse {
  user: {
    id: string;
    email: string;
    username: string;
  };
  accessToken?: string;
}

export const authApi = {
  /**
   * –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É
   * POST /auth/login
   */
  login: async (data: LoginRequest): Promise<AuthResponse> => {
    return api.post<AuthResponse>('/auth/login', data);
  },

  /**
   * –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
   * POST /auth/register
   */
  register: async (data: RegisterRequest): Promise<AuthResponse> => {
    return api.post<AuthResponse>('/auth/register', data);
  },

  /**
   * –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
   * POST /auth/logout
   */
  logout: async (): Promise<void> => {
    return api.post<void>('/auth/logout', {});
  },

  /**
   * –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞
   * POST /auth/refresh
   * –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ api-client
   */
  refresh: async (): Promise<AuthResponse> => {
    return api.post<AuthResponse>('/auth/refresh', {});
  },

  /**
   * –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
   * GET /auth/profile
   */
  getProfile: async (): Promise<AuthResponse['user']> => {
    return api.get<AuthResponse['user']>('/auth/profile');
  },
};
```

---

## üìñ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### –ü–æ—Ç–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

```
1. Login ‚Üí —Å–µ—Ä–≤–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç access + refresh –≤ HTTP-only cookies
2. API –∑–∞–ø—Ä–æ—Å ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–∞–µ—Ç cookies
3. 401 –æ—Ç–≤–µ—Ç ‚Üí api-client –≤—ã–∑—ã–≤–∞–µ—Ç /auth/refresh
4. Refresh —É—Å–ø–µ—à–µ–Ω ‚Üí –ø–æ–≤—Ç–æ—Ä—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –∑–∞–ø—Ä–æ—Å
5. Refresh –Ω–µ—É–¥–∞—á–µ–Ω ‚Üí –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ /login
```

### Cookie –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (—Å–µ—Ä–≤–µ—Ä)

```typescript
// server/src/auth/auth.controller.ts
res.cookie('access_token', accessToken, {
  httpOnly: true,    // –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω —á–µ—Ä–µ–∑ JavaScript
  secure: false,     // true –¥–ª—è HTTPS
  sameSite: 'lax',   // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
  maxAge: 15 * 60 * 1000, // 15 –º–∏–Ω—É—Ç
  path: '/',
});

res.cookie('refresh_token', refreshToken, {
  httpOnly: true,
  secure: false,
  sameSite: 'lax',
  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
  path: '/',
});
```

---

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã

### 1. Race condition –ø—Ä–∏ refresh

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ—Å–∫–æ–ª—å–∫–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –ø–æ–ª—É—á–∞—é—Ç 401 –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ

**–†–µ—à–µ–Ω–∏–µ:** `isRefreshing` —Ñ–ª–∞–≥ –∏ `refreshPromise`

```typescript
if (isRefreshing) {
  return refreshPromise; // –ñ–¥—ë–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π refresh
}
```

### 2. –ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª refresh

**–ü—Ä–æ–±–ª–µ–º–∞:** `/auth/refresh` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç 401 ‚Üí –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª

**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoint

```typescript
if (response.status === 401 && !endpoint.includes('/auth/refresh')) {
  // –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å refresh
}
```

### 3. –£—Ç–µ—á–∫–∞ –ø–∞–º—è—Ç–∏ refreshPromise

**–†–µ—à–µ–Ω–∏–µ:** –û—á–∏—Å—Ç–∫–∞ –≤ finally

```typescript
finally {
  isRefreshing = false;
  refreshPromise = null;
}
```

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

- [x] ApiError –∫–ª–∞—Å—Å—ã —Å–æ–∑–¥–∞–Ω—ã
- [x] apiRequest —Å retry –ª–æ–≥–∏–∫–æ–π —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [x] authApi —Å –º–µ—Ç–æ–¥–∞–º–∏ login/register/logout
- [x] 401 –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] Refresh token rotation —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üéÆ –°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏ –∫ **[–ó–∞–¥–∞—á–∞ 0.5.6: Login –°—Ç—Ä–∞–Ω–∏—Ü–∞](./0.5.6-login-page.md)**

---

## üí° –ü–æ–ª–µ–∑–Ω–æ–µ

### –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö

```tsx
import { authApi } from '../features/auth/auth-api';
import { ApiError, ConflictError } from '../lib/api.errors';

const handleSubmit = async (data: LoginRequest) => {
  try {
    const response = await authApi.login(data);
    // –£—Å–ø–µ—à–Ω—ã–π –ª–æ–≥–∏–Ω - —Ç–æ–∫–µ–Ω—ã –≤ cookies
    navigate('/');
  } catch (error) {
    if (error instanceof ConflictError) {
      // Email —É–∂–µ –∑–∞–Ω—è—Ç
      setError('email', { message: error.message });
    } else if (error instanceof ApiError) {
      // –î—Ä—É–≥–∞—è API –æ—à–∏–±–∫–∞
      setError('root', { message: error.message });
    } else {
      // Network error
      setError('root', { message: 'Network error. Please try again.' });
    }
  }
};
```

### –¢–∏–ø–∏–∑–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤

```typescript
interface User {
  id: string;
  email: string;
  username: string;
}

const user = await api.get<User>('/auth/profile');
// user: User
```
